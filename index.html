<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Football Stats - Manager</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚öΩ</text></svg>">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>‚öΩ Football Stats Manager</h1>
            <p>Gestion compl√®te des statistiques de match</p>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <a href="index.html" class="nav-link active">üè† Accueil</a>
            <a href="pages/team.html" class="nav-link">üë• √âquipe</a>
            <a href="pages/composition.html" class="nav-link">üìã Compo</a>
            <a href="pages/match.html" class="nav-link">‚öΩ Match</a>
            <a href="pages/live.html" class="nav-link">üì∫ Live</a>
            <a href="pages/stats.html" class="nav-link">üìä Stats</a>
        </nav>

        <!-- Page d'accueil -->
        <main class="main-content">
            <div class="team-card">
                <h2>üéÆ Actions Rapides</h2>
                <div class="quick-actions">
                    <button class="btn btn-primary" onclick="startNewMatch()">
                        üÜï Nouveau Match
                    </button>
                    <button class="btn btn-secondary" onclick="showConfirmReset()">
                        üîÑ Reset Complet
                    </button>
                    <button class="btn btn-warning" onclick="loadMatchFile()">
                        üìÇ Charger Sauvegarde
                    </button>
                    <button class="btn btn-success" onclick="downloadCurrentMatch()">
                        üíæ Sauvegarder Match
                    </button>
                </div>
                <input type="file" id="fileInput" accept=".json" style="display: none;">
            </div>

            <div class="team-card">
                <h2>üìã Configuration du Match</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="teamName">Nom de votre √©quipe :</label>
                        <input type="text" id="teamName" placeholder="Mon √âquipe" value="Mon √âquipe">
                    </div>
                    <div class="form-group">
                        <label for="opponentName">√âquipe adverse :</label>
                        <input type="text" id="opponentName" placeholder="√âquipe Adverse" value="√âquipe Adverse">
                    </div>
                    <div class="form-group">
                        <label for="venue">Lieu du match :</label>
                        <input type="text" id="venue" placeholder="Stade Municipal" value="Stade Municipal">
                    </div>
                    <div class="form-group">
                        <label for="matchDate">Date et heure :</label>
                        <input type="datetime-local" id="matchDate">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveMatchConfig()">
                    üíæ Sauvegarder Configuration
                </button>
            </div>

            <div class="team-card">
                <h2>üìä Aper√ßu Rapide</h2>
                <div id="recentStats" class="stats-summary">
                    <p>Commencez par cr√©er votre √©quipe !</p>
                </div>
            </div>

            <div class="team-card">
                <h2>üìñ Guide Rapide</h2>
                <div class="guide-steps">
                    <div class="step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h3>Cr√©er l'√©quipe</h3>
                            <p>Ajoutez vos joueuses dans la section "√âquipe"</p>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h3>S√©lectionner la composition</h3>
                            <p>Choisissez vos 11 titulaires dans "Compo"</p>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h3>Lancer le match</h3>
                            <p>Utilisez l'interface "Match" pour suivre le jeu</p>
                        </div>
                    </div>
                    <div class="step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <h3>Partager en live</h3>
                            <p>G√©n√©rez un lien pour que d'autres suivent le match</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Confirmation Reset -->
    <div id="confirmResetModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeConfirmReset()">&times;</span>
            <h3>‚ö†Ô∏è Confirmation Reset</h3>
            <p>√ätes-vous s√ªr de vouloir effacer toutes les donn√©es ?</p>
            <p style="color: #e74c3c;">Cette action est irr√©versible !</p>
            <div class="modal-actions">
                <button class="btn btn-danger" onclick="confirmReset()">‚úÖ Oui, effacer tout</button>
                <button class="btn btn-secondary" onclick="closeConfirmReset()">‚ùå Annuler</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/utils.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/app.js"></script>
    <script src="js/init.js"></script>
    <script>
        // Attendre que footballApp soit disponible
        function waitForFootballApp(callback) {
            if (typeof footballApp !== 'undefined') {
                callback();
            } else {
                setTimeout(() => waitForFootballApp(callback), 100);
            }
        }

        // Initialisation de la page d'accueil
        document.addEventListener('DOMContentLoaded', function() {
            waitForFootballApp(function() {
                loadMatchConfig();
                updateRecentStats();
                
                // Configuration de la date par d√©faut
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('matchDate').value = now.toISOString().slice(0, 16);
            });
        });

        // ===== FONCTIONS PRINCIPALES =====

        /**
         * Nouveau match via footballApp
         */
        function startNewMatch() {
            waitForFootballApp(function() {
                if (typeof footballApp.startNewMatch === 'function') {
                    footballApp.startNewMatch();
                } else {
                    // Fallback si la fonction n'est pas disponible
                    if (confirm('üÜï Commencer un nouveau match ?\n\n‚ö†Ô∏è Les donn√©es du match en cours seront perdues !')) {
                        // Sauvegarder la config avant reset
                        saveMatchConfig();
                        
                        // Reset des donn√©es de match
                        removeData('currentMatch');
                        
                        footballApp.showNotification('üÜï Nouveau match cr√©√© !', 'success');
                        
                        setTimeout(() => {
                            window.location.href = 'pages/match.html';
                        }, 1500);
                    }
                }
            });
        }

        /**
         * Reset complet via footballApp
         */
        function confirmReset() {
            waitForFootballApp(function() {
                if (typeof footballApp.resetCompleteApp === 'function') {
                    footballApp.resetCompleteApp();
                } else {
                    // Fallback si la fonction n'est pas disponible
                    if (typeof clearAllData === 'function') {
                        clearAllData();
                    }
                    footballApp.showNotification('üîÑ Toutes les donn√©es ont √©t√© effac√©es !', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                }
                closeConfirmReset();
            });
        }

        /**
         * Affichage de la modal de confirmation
         */
        function showConfirmReset() {
            document.getElementById('confirmResetModal').style.display = 'block';
        }

        /**
         * Fermeture de la modal de confirmation
         */
        function closeConfirmReset() {
            document.getElementById('confirmResetModal').style.display = 'none';
        }

        // ===== GESTION DE LA CONFIGURATION =====

        /**
         * Sauvegarde de la configuration du match
         */
        function saveMatchConfig() {
            const config = getMatchConfig();
            saveData('matchConfig', config);
            
            waitForFootballApp(function() {
                footballApp.showNotification('üíæ Configuration sauvegard√©e !', 'success');
            });
        }

        /**
         * R√©cup√©ration de la configuration du formulaire
         */
        function getMatchConfig() {
            return {
                teamName: document.getElementById('teamName').value.trim() || 'Mon √âquipe',
                opponentName: document.getElementById('opponentName').value.trim() || '√âquipe Adverse',
                venue: document.getElementById('venue').value.trim() || 'Stade Municipal',
                matchDate: document.getElementById('matchDate').value || new Date().toISOString()
            };
        }

        /**
         * Chargement de la configuration sauvegard√©e
         */
        function loadMatchConfig() {
            const saved = loadData('matchConfig');
            
            if (saved) {
                document.getElementById('teamName').value = saved.teamName || 'Mon √âquipe';
                document.getElementById('opponentName').value = saved.opponentName || '√âquipe Adverse';
                document.getElementById('venue').value = saved.venue || 'Stade Municipal';
                if (saved.matchDate) {
                    // Convertir la date pour l'input datetime-local
                    const date = new Date(saved.matchDate);
                    date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
                    document.getElementById('matchDate').value = date.toISOString().slice(0, 16);
                }
            }
        }

        // ===== STATISTIQUES ET AFFICHAGE =====

        /**
         * Mise √† jour des statistiques r√©centes
         */
        function updateRecentStats() {
            waitForFootballApp(function() {
                const container = document.getElementById('recentStats');
                const players = loadData('players') || [];
                const currentMatch = loadData('currentMatch');
                
                if (players.length === 0 && !currentMatch) {
                    container.innerHTML = '<p>Aucune donn√©e disponible. Commencez par cr√©er votre √©quipe !</p>';
                    return;
                }
                
                let html = '';
                
                if (players.length > 0) {
                    html += `<div class="stat-item">
                        <span class="stat-icon">üë•</span>
                        <span class="stat-text">${players.length} joueuses dans l'√©quipe</span>
                    </div>`;
                    
                    const fieldPlayers = players.filter(p => p.status === 'field').length;
                    if (fieldPlayers > 0) {
                        html += `<div class="stat-item">
                            <span class="stat-icon">üü¢</span>
                            <span class="stat-text">${fieldPlayers} joueuses sur le terrain</span>
                        </div>`;
                    }
                }
                
                if (currentMatch) {
                    html += `<div class="stat-item">
                        <span class="stat-icon">‚öΩ</span>
                        <span class="stat-text">Match en cours: ${currentMatch.config?.teamName || 'Mon √âquipe'} vs ${currentMatch.config?.opponentName || '√âquipe Adverse'}</span>
                    </div>`;
                    
                    html += `<div class="stat-item">
                        <span class="stat-icon">üïê</span>
                        <span class="stat-text">Score: ${currentMatch.score?.team || 0} - ${currentMatch.score?.opponent || 0}</span>
                    </div>`;
                }
                
                container.innerHTML = html || '<p>Aucune donn√©e disponible.</p>';
            });
        }

        // ===== IMPORT/EXPORT =====

        /**
         * Ouverture du s√©lecteur de fichier
         */
        function loadMatchFile() {
            document.getElementById('fileInput').click();
        }

        /**
         * T√©l√©chargement des donn√©es actuelles
         */
        function downloadCurrentMatch() {
            waitForFootballApp(function() {
                const allData = {
                    players: loadData('players') || [],
                    currentMatch: loadData('currentMatch'),
                    matchConfig: loadData('matchConfig'),
                    timestamp: new Date().toISOString()
                };
                
                if (!allData.players.length && !allData.currentMatch) {
                    footballApp.showNotification('‚ùå Aucune donn√©e √† sauvegarder !', 'error');
                    return;
                }
                
                const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `football_stats_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                footballApp.showNotification('üíæ Donn√©es sauvegard√©es !', 'success');
            });
        }

        // ===== GESTION DU CHARGEMENT DE FICHIER =====

        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    waitForFootballApp(function() {
                        // Importer les donn√©es
                        if (data.players) {
                            saveData('players', data.players);
                        }
                        if (data.currentMatch) {
                            saveData('currentMatch', data.currentMatch);
                        }
                        if (data.matchConfig) {
                            saveData('matchConfig', data.matchConfig);
                            loadMatchConfig();
                        }
                        
                        updateRecentStats();
                        footballApp.showNotification('‚úÖ Donn√©es charg√©es avec succ√®s !', 'success');
                    });
                } catch (error) {
                    waitForFootballApp(function() {
                        footballApp.showNotification('‚ùå Erreur lors du chargement du fichier !', 'error');
                    });
                }
            };
            reader.readAsText(file);
        });
    </script>
</body>
</html>