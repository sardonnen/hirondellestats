<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match - Football Stats</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚öΩ</text></svg>">
    <style>
        /* Styles sp√©cifiques pour la page match */
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        .action-btn {
            padding: 20px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 16px;
            font-weight: 500;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        
        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .action-btn.goal { background: rgba(39, 174, 96, 0.2); border-color: #27ae60; }
        .action-btn.shot { background: rgba(52, 152, 219, 0.2); border-color: #3498db; }
        .action-btn.card { background: rgba(243, 156, 18, 0.2); border-color: #f39c12; }
        .action-btn.foul { background: rgba(231, 76, 60, 0.2); border-color: #e74c3c; }
        .action-btn.save { background: rgba(230, 126, 34, 0.2); border-color: #e67e22; }
        .action-btn.freekick { background: rgba(155, 89, 182, 0.2); border-color: #9b59b6; }
        
        .team-choice-modal .modal-content {
            max-width: 400px;
        }
        
        .team-choice-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .team-choice-btn {
            padding: 20px 30px;
            border: 3px solid;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
            font-weight: bold;
            min-width: 120px;
            text-align: center;
        }
        
        .team-choice-btn.my-team {
            background: rgba(39, 174, 96, 0.2);
            border-color: #27ae60;
            color: white;
        }
        
        .team-choice-btn.opponent-team {
            background: rgba(231, 76, 60, 0.2);
            border-color: #e74c3c;
            color: white;
        }
        
        .team-choice-btn.selected {
            background: white !important;
            color: #2c3e50 !important;
            transform: scale(1.05);
        }
        
        .player-btn.selected {
            background: white !important;
            color: #2c3e50 !important;
            border-color: #27ae60 !important;
        }
        
        .timeline-container {
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .timeline-header {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
            text-align: center;
        }
        
        .timeline-event {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            align-items: center;
        }
        
        .timeline-event:last-child {
            border-bottom: none;
        }
        
        .event-left, .event-right {
            padding: 8px 12px;
            border-radius: 6px;
        }
        
        .event-left {
            text-align: right;
            background: rgba(39, 174, 96, 0.3);
        }
        
        .event-right {
            text-align: left;
            background: rgba(231, 76, 60, 0.3);
        }
        
        .event-time {
            background: rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: bold;
            text-align: center;
            min-width: 60px;
        }
        
        .assist-selection {
            margin: 15px 0;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        
        .assist-selection h4 {
            margin-bottom: 10px;
            color: #f39c12;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Bouton Live fixe -->
        <div class="live-link">
            <button class="btn btn-primary" onclick="generateLiveLink()">üì° Lien Live</button>
        </div>

        <header class="header">
            <h1>‚öΩ Interface de Match</h1>
            <p>Suivez et enregistrez tous les √©v√©nements du match</p>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <a href="../index.html" class="nav-link">üè† Accueil</a>
            <a href="team.html" class="nav-link">üë• √âquipe</a>
            <a href="composition.html" class="nav-link">üìã Compo</a>
            <a href="match.html" class="nav-link active">‚öΩ Match</a>
            <a href="live.html" class="nav-link">üì∫ Live</a>
            <a href="stats.html" class="nav-link">üìä Stats</a>
        </nav>

        <!-- Contenu principal -->
        <main class="main-content">
            
            <!-- Tableau de bord du match -->
            <div class="team-card">
                <div class="match-header">
                    <div class="team-info">
                        <div class="team-name" id="teamName">Mon √âquipe</div>
                        <div class="team-score" id="teamScore">0</div>
                    </div>
                    
                    <div class="match-info">
                        <div class="match-time" id="matchTime">00:00</div>
                        <div class="match-half" id="matchHalf">1√®re Mi-temps</div>
                        <div class="timer-controls">
                            <button class="btn btn-success" id="playBtn" onclick="toggleTimer()">‚ñ∂Ô∏è D√©marrer</button>
                            <button class="btn btn-warning" onclick="resetTimer()">üîÑ Reset</button>
                            <button class="btn btn-primary" onclick="showHalfTimeConfirm()">‚≠ê Mi-temps</button>
                        </div>
                    </div>
                    
                    <div class="team-info">
                        <div class="team-name" id="opponentName">√âquipe Adverse</div>
                        <div class="team-score" id="opponentScore">0</div>
                    </div>
                </div>
            </div>

            <!-- Actions de jeu - 2 boutons par ligne -->
            <div class="team-card">
                <h3>‚öΩ Actions de Jeu</h3>
                <div class="action-buttons">
                    <button class="action-btn goal" onclick="showTeamChoiceModal('goal')">
                        ‚öΩ But
                    </button>
                    <button class="action-btn shot" onclick="showTeamChoiceModal('shot')">
                        üéØ Tir
                    </button>
                    <button class="action-btn card" onclick="showTeamChoiceModal('card')">
                        üü® Carton
                    </button>
                    <button class="action-btn foul" onclick="showTeamChoiceModal('foul')">
                        ‚ö†Ô∏è Faute
                    </button>
                    <button class="action-btn save" onclick="showGoalkeeperModal()">
                        üß§ Arr√™t Gardien
                    </button>
                    <button class="action-btn freekick" onclick="showTeamChoiceModal('freekick')">
                        ‚öΩ Coup Franc
                    </button>
                </div>
            </div>

            <!-- Timeline des √©v√©nements -->
            <div class="team-card">
                <h3>üìù Timeline du Match</h3>
                <div class="timeline-container">
                    <div class="timeline-header">
                        <div>Mon √âquipe</div>
                        <div>Temps</div>
                        <div>√âquipe Adverse</div>
                    </div>
                    <div id="eventsTimeline" class="timeline-events">
                        <div style="text-align: center; padding: 20px; color: #bbb;">
                            Aucun √©v√©nement enregistr√©
                        </div>
                    </div>
                </div>
            </div>

            <!-- R√©sum√© rapide -->
            <div class="team-card">
                <h3>üìä R√©sum√© Rapide</h3>
                <div id="quickStats" class="quick-stats">
                    <!-- Les stats s'afficheront ici -->
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Choix d'√©quipe -->
    <div id="teamChoiceModal" class="modal team-choice-modal">
        <div class="modal-content">
            <span class="close" onclick="closeTeamChoiceModal()">&times;</span>
            <h3 id="teamChoiceTitle">Choisir l'√©quipe</h3>
            
            <div class="team-choice-buttons">
                <div class="team-choice-btn my-team" onclick="selectTeam('my-team')">
                    üü¢ Mon √âquipe
                </div>
                <div class="team-choice-btn opponent-team" onclick="selectTeam('opponent')">
                    üî¥ Adversaire
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Action -->
    <div id="actionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeActionModal()">&times;</span>
            <h3 id="actionModalTitle">Action</h3>
            
            <!-- S√©lection du type de carton -->
            <div id="cardButtons" class="card-buttons" style="display: none;">
                <button class="card-btn yellow-card" onclick="selectCardType('yellow')">üü® Jaune</button>
                <button class="card-btn red-card" onclick="selectCardType('red')">üü• Rouge</button>
                <button class="card-btn white-card" onclick="selectCardType('white')">‚ö™ Blanc (10min)</button>
            </div>
            
            <!-- S√©lection pour la passe d√©cisive (buts seulement) -->
            <div id="assistSelection" class="assist-selection" style="display: none;">
                <h4>üéØ Passe d√©cisive (optionnel):</h4>
                <div id="assistPlayerButtons" class="player-grid">
                    <!-- Boutons pour la passe d√©cisive -->
                </div>
            </div>
            
            <!-- S√©lection du joueur -->
            <div id="actionPlayerButtons" class="player-grid">
                <!-- Boutons des joueuses -->
            </div>
            
            <div class="modal-actions">
                <button id="saveActionBtn" class="btn btn-primary" disabled onclick="saveAction()">üíæ Enregistrer</button>
                <button class="btn btn-secondary" onclick="closeActionModal()">‚ùå Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal Gardien -->
    <div id="goalkeeperModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeGoalkeeperModal()">&times;</span>
            <h3>üß§ Arr√™t de Gardien</h3>
            
            <div class="team-choice-buttons">
                <div class="team-choice-btn my-team" onclick="selectGoalkeeperTeam('my-team')">
                    üü¢ Mon Gardien
                </div>
                <div class="team-choice-btn opponent-team" onclick="selectGoalkeeperTeam('opponent')">
                    üî¥ Gardien Adverse
                </div>
            </div>
            
            <div id="goalkeeperPlayerButtons" class="player-grid" style="display: none;">
                <!-- Boutons des gardiens -->
            </div>
            
            <div class="form-group" id="saveTypeGroup" style="display: none;">
                <label for="saveType">Type d'arr√™t :</label>
                <select id="saveType">
                    <option value="line">Sur sa ligne</option>
                    <option value="out">En sortie</option>
                    <option value="penalty">Penalty</option>
                    <option value="corner">Corner</option>
                </select>
            </div>
            
            <div class="modal-actions">
                <button id="saveGoalkeeperBtn" class="btn btn-primary" disabled onclick="saveGoalkeeperAction()">üíæ Enregistrer</button>
                <button class="btn btn-secondary" onclick="closeGoalkeeperModal()">‚ùå Annuler</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/storage.js"></script>
    <script src="../js/app.js"></script>
    <script>
        // Variables locales de la page match
        let selectedPlayerId = null;
        let selectedAssistPlayerId = null;
        let selectedCardType = null;
        let selectedTeam = null;
        let currentActionType = null;
        let currentGoalkeeperTeam = null;
        let selectedGoalkeeperId = null;
        
        // Variables pour le timer
        let matchTimer = {
            startTime: null,
            pausedTime: 0,
            isRunning: false,
            currentHalf: 1,
            interval: null
        };
        
        // Tableau des √©v√©nements
        let matchEvents = [];
        
        // Stats du match
        let matchStats = {
            myTeam: { goals: 0, shots: 0, cards: 0, fouls: 0, saves: 0 },
            opponent: { goals: 0, shots: 0, cards: 0, fouls: 0, saves: 0 }
        };

        // Initialisation de la page
        document.addEventListener('DOMContentLoaded', function() {
            initializeMatchPage();
        });

        /**
         * Initialisation de la page de match
         */
        function initializeMatchPage() {
            loadMatchConfig();
            updateMatchDisplay();
            startPeriodicSave();
            console.log('Page de match initialis√©e');
        }

        /**
         * Chargement de la configuration du match
         */
        function loadMatchConfig() {
            const config = getMatchConfig();
            document.getElementById('teamName').textContent = config.teamName || 'Mon √âquipe';
            document.getElementById('opponentName').textContent = config.opponentName || '√âquipe Adverse';
        }

        // ===== GESTION DU TIMER =====
        
        function toggleTimer() {
            if (matchTimer.isRunning) {
                stopTimer();
            } else {
                startTimer();
            }
        }
        
        function startTimer() {
            if (matchTimer.isRunning) return;
            
            matchTimer.isRunning = true;
            matchTimer.startTime = Date.now() - (matchTimer.pausedTime * 1000);
            
            matchTimer.interval = setInterval(updateTimer, 1000);
            
            document.getElementById('playBtn').innerHTML = '‚è∏Ô∏è Pause';
            document.getElementById('playBtn').classList.remove('btn-success');
            document.getElementById('playBtn').classList.add('btn-warning');
            
            // Sauvegarder automatiquement
            autoSave();
        }
        
        function stopTimer() {
            if (!matchTimer.isRunning) return;
            
            matchTimer.isRunning = false;
            matchTimer.pausedTime = (Date.now() - matchTimer.startTime) / 1000;
            
            clearInterval(matchTimer.interval);
            
            document.getElementById('playBtn').innerHTML = '‚ñ∂Ô∏è Reprendre';
            document.getElementById('playBtn').classList.remove('btn-warning');
            document.getElementById('playBtn').classList.add('btn-success');
            
            // Sauvegarder automatiquement
            autoSave();
        }
        
        function resetTimer() {
            stopTimer();
            matchTimer.pausedTime = 0;
            matchTimer.startTime = null;
            updateTimerDisplay();
            
            document.getElementById('playBtn').innerHTML = '‚ñ∂Ô∏è D√©marrer';
            document.getElementById('playBtn').classList.remove('btn-warning');
            document.getElementById('playBtn').classList.add('btn-success');
            
            // Sauvegarder automatiquement
            autoSave();
        }
        
        function updateTimer() {
            if (!matchTimer.isRunning || !matchTimer.startTime) return;
            
            const elapsedSeconds = (Date.now() - matchTimer.startTime) / 1000;
            let totalSeconds = Math.floor(elapsedSeconds);
            
            // Pour la deuxi√®me mi-temps, commencer √† 45 minutes
            if (matchTimer.currentHalf === 2) {
                totalSeconds += 45 * 60;
            }
            
            updateTimerDisplay(totalSeconds);
            
            // Sauvegarder toutes les minutes
            if (totalSeconds % 60 === 0) {
                autoSave();
            }
        }
        
        function updateTimerDisplay(totalSeconds = null) {
            if (totalSeconds === null) {
                totalSeconds = matchTimer.pausedTime;
                if (matchTimer.currentHalf === 2) {
                    totalSeconds += 45 * 60;
                }
            }
            
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.floor(totalSeconds % 60);
            
            let displayTime;
            if (minutes >= 45 && matchTimer.currentHalf === 1) {
                const overtimeMinutes = minutes - 45;
                displayTime = `45+${overtimeMinutes}:${seconds.toString().padStart(2, '0')}`;
            } else if (minutes >= 90 && matchTimer.currentHalf === 2) {
                const overtimeMinutes = minutes - 90;
                displayTime = `90+${overtimeMinutes}:${seconds.toString().padStart(2, '0')}`;
            } else {
                displayTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            document.getElementById('matchTime').textContent = displayTime;
        }
        
        function showHalfTimeConfirm() {
            if (matchTimer.currentHalf === 2) {
                if (confirm('Voulez-vous terminer le match ?')) {
                    endMatch();
                }
            } else {
                if (confirm('Voulez-vous passer √† la seconde mi-temps ?')) {
                    switchToSecondHalf();
                }
            }
        }
        
        function switchToSecondHalf() {
            stopTimer();
            matchTimer.currentHalf = 2;
            matchTimer.pausedTime = 0; // Reset √† 0 pour commencer la 2e mi-temps √† 45:00
            matchTimer.startTime = null;
            
            document.getElementById('matchHalf').textContent = '2√®me Mi-temps';
            updateTimerDisplay();
            
            addEvent('system', {
                description: 'D√©but de la 2√®me mi-temps',
                team: null
            });
            
            // Sauvegarder automatiquement
            autoSave();
        }
        
        function endMatch() {
            stopTimer();
            addEvent('system', {
                description: 'Fin du match',
                team: null
            });
            
            // Sauvegarder automatiquement
            autoSave();
            
            alert('Match termin√© ! Consultez les statistiques dans l\'onglet Stats.');
        }

        // ===== GESTION DES MODALS =====
        
        function showTeamChoiceModal(actionType) {
            currentActionType = actionType;
            
            const titles = {
                'goal': 'Qui a marqu√© le but ?',
                'shot': 'Qui a tir√© ?',
                'card': 'Qui re√ßoit le carton ?',
                'foul': 'Qui a commis la faute ?',
                'freekick': 'Qui tire le coup franc ?'
            };
            
            document.getElementById('teamChoiceTitle').textContent = titles[actionType] || 'Choisir l\'√©quipe';
            
            // Reset des s√©lections
            resetTeamChoiceButtons();
            
            document.getElementById('teamChoiceModal').style.display = 'block';
        }
        
        function resetTeamChoiceButtons() {
            const buttons = document.querySelectorAll('.team-choice-btn');
            buttons.forEach(btn => btn.classList.remove('selected'));
        }
        
        function selectTeam(team) {
            selectedTeam = team;
            
            // Mise √† jour visuelle
            resetTeamChoiceButtons();
            const selectedBtn = document.querySelector(`.team-choice-btn.${team === 'my-team' ? 'my-team' : 'opponent-team'}`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }
            
            // Attendre un peu pour l'effet visuel puis ouvrir le modal d'action
            setTimeout(() => {
                closeTeamChoiceModal();
                showActionModal();
            }, 300);
        }
        
        function closeTeamChoiceModal() {
            document.getElementById('teamChoiceModal').style.display = 'none';
            resetTeamChoiceButtons();
        }
        
        function showActionModal() {
            const titles = {
                'goal': selectedTeam === 'my-team' ? 'But marqu√© - Mon √âquipe' : 'But marqu√© - √âquipe Adverse',
                'shot': selectedTeam === 'my-team' ? 'Tir - Mon √âquipe' : 'Tir - √âquipe Adverse',
                'card': selectedTeam === 'my-team' ? 'Carton - Mon √âquipe' : 'Carton - √âquipe Adverse',
                'foul': selectedTeam === 'my-team' ? 'Faute - Mon √âquipe' : 'Faute - √âquipe Adverse',
                'freekick': selectedTeam === 'my-team' ? 'Coup Franc - Mon √âquipe' : 'Coup Franc - √âquipe Adverse'
            };
            
            document.getElementById('actionModalTitle').textContent = titles[currentActionType] || 'Action';
            
            // Afficher/cacher les √©l√©ments sp√©cifiques
            const cardButtons = document.getElementById('cardButtons');
            const assistSelection = document.getElementById('assistSelection');
            
            cardButtons.style.display = currentActionType === 'card' ? 'block' : 'none';
            assistSelection.style.display = (currentActionType === 'goal' && selectedTeam === 'my-team') ? 'block' : 'none';
            
            // Charger les joueurs appropri√©s
            loadPlayersForAction();
            
            // Reset des s√©lections
            selectedPlayerId = null;
            selectedAssistPlayerId = null;
            selectedCardType = null;
            
            document.getElementById('actionModal').style.display = 'block';
            updateSaveButton();
        }
        
        function loadPlayersForAction() {
            const container = document.getElementById('actionPlayerButtons');
            const assistContainer = document.getElementById('assistPlayerButtons');
            container.innerHTML = '';
            if (assistContainer) assistContainer.innerHTML = '';
            
            if (selectedTeam === 'my-team') {
                // Charger les joueurs de mon √©quipe
                const players = getMyTeamPlayers();
                players.forEach(player => {
                    const button = document.createElement('button');
                    button.className = 'player-btn';
                    button.innerHTML = `
                        <div>${player.name}</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">${player.position}</div>
                    `;
                    button.onclick = () => selectPlayer(player.id, button);
                    container.appendChild(button);
                    
                    // Ajouter aussi dans la s√©lection d'assistance si n√©cessaire
                    if (currentActionType === 'goal' && assistContainer) {
                        const assistButton = document.createElement('button');
                        assistButton.className = 'player-btn assist-btn';
                        assistButton.innerHTML = `
                            <div>${player.name}</div>
                            <div style="font-size: 0.8rem; opacity: 0.8;">${player.position}</div>
                        `;
                        assistButton.onclick = () => selectAssistPlayer(player.id, assistButton);
                        assistContainer.appendChild(assistButton);
                    }
                });
            } else {
                // Pour l'√©quipe adverse, afficher des options g√©n√©riques
                const adversaryPositions = ['Gardien', 'D√©fenseur', 'Milieu', 'Attaquant'];
                adversaryPositions.forEach((position, index) => {
                    const button = document.createElement('button');
                    button.className = 'player-btn opponent';
                    button.innerHTML = `
                        <div>Joueur Adverse</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">${position}</div>
                    `;
                    button.onclick = () => selectPlayer(`opponent_${index}`, button);
                    container.appendChild(button);
                });
            }
        }
        
        function selectPlayer(playerId, buttonElement) {
            selectedPlayerId = playerId;
            
            // Mise √† jour visuelle
            const buttons = document.querySelectorAll('#actionPlayerButtons .player-btn');
            buttons.forEach(btn => btn.classList.remove('selected'));
            buttonElement.classList.add('selected');
            
            updateSaveButton();
        }
        
        function selectAssistPlayer(playerId, buttonElement) {
            selectedAssistPlayerId = playerId;
            
            // Mise √† jour visuelle
            const buttons = document.querySelectorAll('#assistPlayerButtons .assist-btn');
            buttons.forEach(btn => btn.classList.remove('selected'));
            buttonElement.classList.add('selected');
        }
        
        function selectCardType(cardType) {
            selectedCardType = cardType;
            
            // Mise √† jour visuelle
            const buttons = document.querySelectorAll('.card-btn');
            buttons.forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            
            updateSaveButton();
        }
        
        function updateSaveButton() {
            const saveBtn = document.getElementById('saveActionBtn');
            if (!saveBtn) return;
            
            let canSave = selectedPlayerId !== null;
            
            // Pour les cartons, il faut aussi s√©lectionner le type
            if (currentActionType === 'card') {
                canSave = canSave && selectedCardType !== null;
            }
            
            saveBtn.disabled = !canSave;
        }
        
        function closeActionModal() {
            document.getElementById('actionModal').style.display = 'none';
            
            // Reset des s√©lections
            selectedPlayerId = null;
            selectedAssistPlayerId = null;
            selectedCardType = null;
            selectedTeam = null;
            currentActionType = null;
        }
        
        function saveAction() {
            if (!selectedPlayerId) {
                alert('S√©lectionnez un joueur');
                return;
            }
            
            if (currentActionType === 'card' && !selectedCardType) {
                alert('S√©lectionnez un type de carton');
                return;
            }
            
            // Cr√©er l'√©v√©nement
            const eventData = {
                type: currentActionType,
                team: selectedTeam,
                playerId: selectedPlayerId,
                time: getCurrentMatchTime()
            };
            
            if (currentActionType === 'card') {
                eventData.cardType = selectedCardType;
            }
            
            if (currentActionType === 'goal' && selectedAssistPlayerId) {
                eventData.assistPlayerId = selectedAssistPlayerId;
            }
            
            // Ajouter l'√©v√©nement
            addEvent(currentActionType, eventData);
            
            // Mettre √† jour les stats
            updateMatchStats(eventData);
            
            closeActionModal();
            updateMatchDisplay();
            
            // Sauvegarder automatiquement
            autoSave();
        }

        // ===== GESTION DU MODAL GARDIEN =====
        
        function showGoalkeeperModal() {
            // Reset des s√©lections
            currentGoalkeeperTeam = null;
            selectedGoalkeeperId = null;
            
            // Cacher les √©l√©ments avanc√©s
            document.getElementById('goalkeeperPlayerButtons').style.display = 'none';
            document.getElementById('saveTypeGroup').style.display = 'none';
            
            // Reset des boutons
            const buttons = document.querySelectorAll('.team-choice-btn');
            buttons.forEach(btn => btn.classList.remove('selected'));
            
            document.getElementById('goalkeeperModal').style.display = 'block';
        }
        
        function selectGoalkeeperTeam(team) {
            currentGoalkeeperTeam = team;
            
            // Mise √† jour visuelle
            const buttons = document.querySelectorAll('#goalkeeperModal .team-choice-btn');
            buttons.forEach(btn => btn.classList.remove('selected'));
            const selectedBtn = document.querySelector(`#goalkeeperModal .team-choice-btn.${team === 'my-team' ? 'my-team' : 'opponent-team'}`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }
            
            // Afficher la s√©lection des gardiens
            loadGoalkeepers();
            document.getElementById('goalkeeperPlayerButtons').style.display = 'block';
            document.getElementById('saveTypeGroup').style.display = 'block';
        }
        
        function loadGoalkeepers() {
            const container = document.getElementById('goalkeeperPlayerButtons');
            container.innerHTML = '';
            
            if (currentGoalkeeperTeam === 'my-team') {
                const goalkeepers = getMyTeamGoalkeepers();
                goalkeepers.forEach(gk => {
                    const button = document.createElement('button');
                    button.className = 'player-btn goalkeeper-btn';
                    button.innerHTML = `
                        <div>${gk.name}</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">Gardien</div>
                    `;
                    button.onclick = () => selectGoalkeeper(gk.id, button);
                    container.appendChild(button);
                });
            } else {
                // Gardien adverse
                const button = document.createElement('button');
                button.className = 'player-btn goalkeeper-btn opponent';
                button.innerHTML = `
                    <div>Gardien Adverse</div>
                    <div style="font-size: 0.8rem; opacity: 0.8;">Gardien</div>
                `;
                button.onclick = () => selectGoalkeeper('opponent_gk', button);
                container.appendChild(button);
            }
        }
        
        function selectGoalkeeper(goalkeeperId, buttonElement) {
            selectedGoalkeeperId = goalkeeperId;
            
            // Mise √† jour visuelle
            const buttons = document.querySelectorAll('#goalkeeperPlayerButtons .goalkeeper-btn');
            buttons.forEach(btn => btn.classList.remove('selected'));
            buttonElement.classList.add('selected');
            
            document.getElementById('saveGoalkeeperBtn').disabled = false;
        }
        
        function closeGoalkeeperModal() {
            document.getElementById('goalkeeperModal').style.display = 'none';
            currentGoalkeeperTeam = null;
            selectedGoalkeeperId = null;
        }
        
        function saveGoalkeeperAction() {
            if (!selectedGoalkeeperId) {
                alert('S√©lectionnez un gardien');
                return;
            }
            
            const saveType = document.getElementById('saveType').value;
            
            const eventData = {
                type: 'save',
                team: currentGoalkeeperTeam,
                playerId: selectedGoalkeeperId,
                saveType: saveType,
                time: getCurrentMatchTime()
            };
            
            addEvent('save', eventData);
            updateMatchStats(eventData);
            
            closeGoalkeeperModal();
            updateMatchDisplay();
            
            // Sauvegarder automatiquement
            autoSave();
        }

        // ===== GESTION DES √âV√âNEMENTS =====
        
        function getCurrentMatchTime() {
            let totalSeconds = matchTimer.pausedTime;
            if (matchTimer.isRunning && matchTimer.startTime) {
                totalSeconds = (Date.now() - matchTimer.startTime) / 1000;
            }
            
            if (matchTimer.currentHalf === 2) {
                totalSeconds += 45 * 60;
            }
            
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.floor(totalSeconds % 60);
            
            if (minutes >= 45 && matchTimer.currentHalf === 1) {
                const overtimeMinutes = minutes - 45;
                return `45+${overtimeMinutes}:${seconds.toString().padStart(2, '0')}`;
            } else if (minutes >= 90 && matchTimer.currentHalf === 2) {
                const overtimeMinutes = minutes - 90;
                return `90+${overtimeMinutes}:${seconds.toString().padStart(2, '0')}`;
            } else {
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        function addEvent(type, data) {
            const event = {
                id: Date.now(),
                type: type,
                ...data,
                timestamp: new Date()
            };
            
            matchEvents.unshift(event); // Ajouter au d√©but pour avoir les plus r√©cents en haut
            updateTimeline();
        }
        
        function updateTimeline() {
            const container = document.getElementById('eventsTimeline');
            
            if (matchEvents.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #bbb;">Aucun √©v√©nement enregistr√©</div>';
                return;
            }
            
            container.innerHTML = '';
            
            matchEvents.forEach(event => {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'timeline-event';
                
                const leftDiv = document.createElement('div');
                const timeDiv = document.createElement('div');
                const rightDiv = document.createElement('div');
                
                leftDiv.className = 'event-left';
                timeDiv.className = 'event-time';
                rightDiv.className = 'event-right';
                
                timeDiv.textContent = event.time;
                
                if (event.team === 'my-team') {
                    leftDiv.innerHTML = getEventDescription(event);
                    rightDiv.innerHTML = '';
                } else if (event.team === 'opponent') {
                    leftDiv.innerHTML = '';
                    rightDiv.innerHTML = getEventDescription(event);
                } else {
                    // √âv√©nements syst√®me (mi-temps, etc.)
                    leftDiv.innerHTML = '';
                    rightDiv.innerHTML = '';
                    timeDiv.innerHTML = `<div style="text-align: center; font-style: italic;">${event.description || getEventDescription(event)}</div>`;
                }
                
                eventDiv.appendChild(leftDiv);
                eventDiv.appendChild(timeDiv);
                eventDiv.appendChild(rightDiv);
                
                container.appendChild(eventDiv);
            });
        }
        
        function getEventDescription(event) {
            const playerName = getPlayerName(event.playerId);
            
            switch (event.type) {
                case 'goal':
                    let goalText = `‚öΩ ${playerName}`;
                    if (event.assistPlayerId) {
                        const assistName = getPlayerName(event.assistPlayerId);
                        goalText += `<br><small>üéØ Passe: ${assistName}</small>`;
                    }
                    return goalText;
                case 'shot':
                    return `üéØ Tir - ${playerName}`;
                case 'card':
                    const cardEmoji = event.cardType === 'yellow' ? 'üü®' : event.cardType === 'red' ? 'üü•' : '‚ö™';
                    return `${cardEmoji} Carton - ${playerName}`;
                case 'foul':
                    return `‚ö†Ô∏è Faute - ${playerName}`;
                case 'save':
                    return `üß§ Arr√™t - ${playerName}`;
                case 'freekick':
                    return `‚öΩ Coup Franc - ${playerName}`;
                default:
                    return event.description || `${event.type} - ${playerName}`;
            }
        }
        
        function getPlayerName(playerId) {
            if (typeof playerId === 'string' && playerId.startsWith('opponent_')) {
                return 'Joueur Adverse';
            }
            
            // R√©cup√©rer le nom du joueur depuis les donn√©es de l'√©quipe
            const players = getMyTeamPlayers();
            const player = players.find(p => p.id === playerId);
            return player ? player.name : 'Joueur';
        }
        
        function updateMatchStats(eventData) {
            const team = eventData.team === 'my-team' ? 'myTeam' : 'opponent';
            
            switch (eventData.type) {
                case 'goal':
                    matchStats[team].goals++;
                    break;
                case 'shot':
                    matchStats[team].shots++;
                    break;
                case 'card':
                    matchStats[team].cards++;
                    break;
                case 'foul':
                    matchStats[team].fouls++;
                    break;
                case 'save':
                    matchStats[team].saves++;
                    break;
            }
        }
        
        function updateMatchDisplay() {
            // Mettre √† jour les scores
            document.getElementById('teamScore').textContent = matchStats.myTeam.goals;
            document.getElementById('opponentScore').textContent = matchStats.opponent.goals;
            
            // Mettre √† jour les stats rapides
            updateQuickStats();
        }
        
        function updateQuickStats() {
            const container = document.getElementById('quickStats');
            container.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">${matchStats.myTeam.goals}</div>
                        <div class="stat-label">Buts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${matchStats.myTeam.shots}</div>
                        <div class="stat-label">Tirs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${matchStats.myTeam.cards}</div>
                        <div class="stat-label">Cartons</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${matchStats.myTeam.saves}</div>
                        <div class="stat-label">Arr√™ts</div>
                    </div>
                </div>
            `;
        }

        // ===== FONCTIONS UTILITAIRES =====
        
        function getMyTeamPlayers() {
            // R√©cup√©rer les joueurs depuis le stockage local
            const players = JSON.parse(localStorage.getItem('players') || '[]');
            return players;
        }
        
        function getMyTeamGoalkeepers() {
            const players = getMyTeamPlayers();
            return players.filter(p => p.position.toLowerCase().includes('garden') || p.position.toLowerCase().includes('goal'));
        }
        
        function getMatchConfig() {
            return JSON.parse(localStorage.getItem('matchConfig') || '{"teamName": "Mon √âquipe", "opponentName": "√âquipe Adverse"}');
        }
        
        function startPeriodicSave() {
            // Sauvegarder automatiquement toutes les 30 secondes
            setInterval(autoSave, 30000);
        }
        
        async function autoSave() {
            const matchData = {
                timer: matchTimer,
                events: matchEvents,
                stats: matchStats,
                lastUpdate: new Date().toISOString()
            };
            
            // Sauvegarder localement
            localStorage.setItem('currentMatch', JSON.stringify(matchData));
            
            // Sauvegarder sur jsonbin.io
            try {
                await saveToJsonBin(matchData);
                console.log('Match sauvegard√© automatiquement');
            } catch (error) {
                console.error('Erreur sauvegarde automatique:', error);
            }
        }
        
        async function saveToJsonBin(data) {
            const API_KEY = '$2a$10$L3uaRDnltfCsdgv50dAJ0.aTJsslnmT2SPju9EPNd6HvXqW6u9KmS';
            const API_BASE_URL = 'https://api.jsonbin.io/v3/b';
            
            try {
                const response = await fetch(API_BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': API_KEY
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error('Erreur sauvegarde JsonBin');
                }
                
                const result = await response.json();
                return result.metadata.id;
            } catch (error) {
                console.error('Erreur JsonBin:', error);
                throw error;
            }
        }
        
        // Fonction pour g√©n√©rer le lien live (√† impl√©menter selon vos besoins)
        function generateLiveLink() {
            alert('Fonctionnalit√© de lien live √† impl√©menter');
        }
    </script>
</body>
</html>