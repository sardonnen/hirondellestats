<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Composition - Football Stats</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚öΩ</text></svg>">
    <style>
        /* Liste compacte pour les stats */
        .stats-compact-list {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 15px 20px;
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .stat-line {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
        }
        
        .stat-line .stat-value {
            font-weight: bold;
            color: #3498db;
            font-size: 1.3em;
            min-width: 30px;
        }
        
        .stat-line .stat-label {
            color: rgba(255, 255, 255, 0.9);
        }
        
        /* Titres de rubrique plus petits */
        .team-card h2 {
            font-size: 1.3em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Cat√©gories de joueuses par position */
        .players-by-position {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .position-category {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .position-category-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border-left: 4px solid #f39c12;
        }
        
        .position-category-icon {
            font-size: 1.5em;
        }
        
        .position-category-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #f39c12;
            margin: 0;
        }
        
        .position-category-players {
            display: grid !important;
            grid-template-columns: repeat(3, 1fr) !important;
            gap: 10px;
        }
        
        .composition-status {
            padding: 15px;
            border-radius: 12px;
            margin: 10px 0;
            text-align: center;
            font-weight: 600;
        }

        .composition-status.success {
            background: rgba(39, 174, 96, 0.2);
            border: 2px solid #27ae60;
            color: #27ae60;
        }

        .composition-status.warning {
            background: rgba(243, 156, 18, 0.2);
            border: 2px solid #f39c12;
            color: #f39c12;
        }

        .composition-status.error {
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid #e74c3c;
            color: #e74c3c;
        }

        .formation-display {
            margin: 20px 0;
            background: rgba(34, 139, 34, 0.1);
            border-radius: 12px;
            padding: 20px;
        }

        .field {
            background: linear-gradient(to bottom, #2d8a2f, #1a5f1d);
            border-radius: 8px;
            padding: 20px;
            min-height: 400px;
            position: relative;
            border: 3px solid white;
        }

        .field-line {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            min-height: 80px;
        }

        .field-position {
            text-align: center;
            width: 100%;
        }

        .position-label {
            font-weight: bold;
            margin-bottom: 10px;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }

        .players-in-position {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .field-player {
            background: rgba(255,255,255,0.9);
            color: #2c3e50;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            min-width: 60px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .player-name {
            font-size: 11px;
        }

        .player-number {
            font-size: 10px;
            opacity: 0.8;
        }

        .empty-position {
            color: rgba(255,255,255,0.6);
            font-style: italic;
            font-size: 12px;
        }

        /* Positionnement manuel */
        .position-slot {
            background: rgba(255,255,255,0.9);
            color: #2c3e50;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-align: center;
            min-width: 70px;
            min-height: 50px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .position-slot.empty {
            background: rgba(255,255,255,0.3);
            border: 2px dashed rgba(255,255,255,0.6);
        }

        .position-slot.empty:hover {
            background: rgba(255,255,255,0.5);
            transform: scale(1.05);
        }

        .position-slot.filled:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.4);
        }

        .empty-slot {
            font-size: 24px;
            opacity: 0.6;
        }

        .player-selection-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
        }

        .player-select-btn {
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 14px;
        }

        .player-select-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateX(5px);
        }

        .starting-eleven-list,
        .bench-list {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .players-list {
            margin-top: 10px;
        }

        .position-group {
            margin: 10px 0;
        }

        .position-group h4 {
            color: #f39c12;
            margin-bottom: 5px;
        }

        .position-group ul {
            list-style: none;
            padding-left: 0;
        }

        .position-group li {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .formations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .formation-btn {
            padding: 20px;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .formation-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .formation-name {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .formation-desc {
            font-size: 12px;
            opacity: 0.8;
        }

        .formation-summary {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .position-summary div {
            margin: 10px 0;
            padding: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
        }

        @media (max-width: 768px) {
            .stats-grid-composition {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .position-category-players {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .field {
                min-height: 300px;
                padding: 15px;
            }

            .field-line {
                margin: 15px 0;
                min-height: 60px;
            }

            .field-player, .position-slot {
                padding: 6px 10px;
                font-size: 10px;
                min-width: 50px;
            }

            .formations-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üìã Composition de D√©part</h1>
            <p>S√©lectionnez vos 11 titulaires pour le match</p>
        </header>

        <nav class="nav-tabs">
            <a href="../index.html" class="nav-link">üè† Accueil</a>
            <a href="team.html" class="nav-link">üë• √âquipe</a>
            <a href="composition.html" class="nav-link active">üìã Compo</a>
            <a href="match.html" class="nav-link">‚öΩ Match</a>
            <a href="live.html" class="nav-link">üì∫ Live</a>
            <a href="stats.html" class="nav-link">üìä Stats</a>
        </nav>

        <main class="main-content">
            
            <!-- Statut de la composition -->
            <div class="team-card">
                <h2 style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">üéØ Statut de la Composition</h2>
                <div class="stats-compact-list">
                    <div class="stat-line">
                        <span class="stat-value" id="selectedCount">0</span>
                        <span class="stat-label">Joueuses S√©lectionn√©es</span>
                    </div>
                    <div class="stat-line">
                        <span class="stat-value" id="goalkeepersSelected">0</span>
                        <span class="stat-label">Gardiennes</span>
                    </div>
                    <div class="stat-line">
                        <span class="stat-value" id="defendersSelected">0</span>
                        <span class="stat-label">D√©fenseures</span>
                    </div>
                    <div class="stat-line">
                        <span class="stat-value" id="midfieldersSelected">0</span>
                        <span class="stat-label">Milieux</span>
                    </div>
                    <div class="stat-line">
                        <span class="stat-value" id="attackersSelected">0</span>
                        <span class="stat-label">Attaquantes</span>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <div id="compositionStatus" class="composition-status">
                        <span class="status-icon">‚ö†Ô∏è</span>
                        <span class="status-text">S√©lectionnez 11 joueuses avec au moins 1 gardienne</span>
                    </div>
                </div>
            </div>

            <!-- S√©lection des joueuses -->
            <div class="team-card">
                <h2 style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">üë• S√©lection des Joueuses</h2>
                <p>Cliquez sur les joueuses pour les ajouter/retirer de la composition de d√©part :</p>
                
                <div id="playersSelectionGrid" class="players-by-position">
                    <!-- Les joueuses appara√Ætront ici par cat√©gorie -->
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="clearSelection()">üîÑ Tout D√©s√©lectionner</button>
                    <button class="btn btn-warning" onclick="autoSelectComposition()">üé≤ S√©lection Auto</button>
                    <button class="btn btn-primary" id="validateBtn" onclick="validateComposition()" disabled>
                        ‚úÖ Valider la Composition
                    </button>
                </div>
            </div>

            <!-- Aper√ßu de la composition -->
            <div class="team-card">
                <h2>üü© Aper√ßu de la Composition</h2>
                
                <!-- Mode de visualisation -->
                <div style="text-align: center; margin-bottom: 20px;">
                    <button class="btn" id="togglePositioningBtn" onclick="togglePositioningMode()">
                        üéØ Mode Positionnement Manuel
                    </button>
                    <button class="btn btn-success" id="validatePositioningBtn" onclick="validatePositioning()" style="display: none;">
                        ‚úÖ Valider le Positionnement
                    </button>
                    <p id="positioningModeText" style="margin-top: 10px; color: #f39c12; display: none;">
                        Cliquez sur une position vide ou sur une joueuse pour la (re)positionner
                    </p>
                </div>
                
                <!-- Formation visuelle -->
                <div class="formation-display">
                    <div class="field">
                        <!-- Gardienne -->
                        <div class="field-line goalkeeper-line">
                            <div class="field-position" id="gk-position">
                                <div class="position-label">Gardienne</div>
                                <div class="players-in-position" id="gk-players"></div>
                            </div>
                        </div>
                        
                        <!-- D√©fense -->
                        <div class="field-line defense-line">
                            <div class="field-position" id="def-position">
                                <div class="position-label">D√©fense</div>
                                <div class="players-in-position" id="def-players"></div>
                            </div>
                        </div>
                        
                        <!-- Milieu -->
                        <div class="field-line midfield-line">
                            <div class="field-position" id="mid-position">
                                <div class="position-label">Milieu</div>
                                <div class="players-in-position" id="mid-players"></div>
                            </div>
                        </div>
                        
                        <!-- Attaque -->
                        <div class="field-line attack-line">
                            <div class="field-position" id="att-position">
                                <div class="position-label">Attaque</div>
                                <div class="players-in-position" id="att-players"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Liste des titulaires -->
                <div class="starting-eleven-list">
                    <h3>üìù 11 de D√©part</h3>
                    <div id="startingElevenList" class="players-list">
                        <p>Aucune joueuse s√©lectionn√©e</p>
                    </div>
                </div>
                
                <!-- Banc de touche -->
                <div class="bench-list">
                    <h3>ü™ë Banc de Touche</h3>
                    <div id="benchList" class="players-list">
                        <p>Aucune joueuse sur le banc</p>
                    </div>
                </div>
            </div>

            <!-- Formations pr√©d√©finies -->
            <div class="team-card">
                <h2>‚öôÔ∏è Formations Pr√©d√©finies</h2>
                <p>S√©lectionnez une formation classique :</p>
                
                <div class="formations-grid">
                    <button class="formation-btn" onclick="applyFormation('4-4-2')">
                        <div class="formation-name">4-4-2</div>
                        <div class="formation-desc">√âquilibr√©e</div>
                    </button>
                    <button class="formation-btn" onclick="applyFormation('4-3-3')">
                        <div class="formation-name">4-3-3</div>
                        <div class="formation-desc">Offensive</div>
                    </button>
                    <button class="formation-btn" onclick="applyFormation('4-2-3-1')">
                        <div class="formation-name">4-2-3-1</div>
                        <div class="formation-desc">Moderne</div>
                    </button>
                    <button class="formation-btn" onclick="applyFormation('3-5-2')">
                        <div class="formation-name">3-5-2</div>
                        <div class="formation-desc">Milieu renforc√©</div>
                    </button>
                    <button class="formation-btn" onclick="applyFormation('5-3-2')">
                        <div class="formation-name">5-3-2</div>
                        <div class="formation-desc">D√©fensive</div>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Validation -->
    <div id="validationModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeValidationModal()">&times;</span>
            <h3>‚úÖ Composition Valid√©e</h3>
            <p>Votre composition de d√©part a √©t√© valid√©e avec succ√®s !</p>
            
            <div id="validatedComposition" style="margin: 20px 0;">
                <!-- R√©sum√© de la composition -->
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="goToMatch()">‚öΩ Aller au Match</button>
                <button class="btn btn-secondary" onclick="closeValidationModal()">üìù Continuer l'√âdition</button>
            </div>
        </div>
    </div>

    <script src="../js/storage.js"></script>
    <script src="../js/app.js"></script>
    <script>
        // Variables locales
        let selectedPlayers = [];
        let positioningMode = false;
        let positioningValidated = false; // √âtat de validation du positionnement
        let playerPositions = {};

        document.addEventListener('DOMContentLoaded', function() {
            migratePlayerPositions(); // Corriger les anciennes positions
            loadCurrentComposition();
            loadPlayerPositions();
            updatePlayersSelectionDisplay();
            updateCompositionStats();
            updateFormationDisplay();
        });

        /**
         * Migration des positions "d√©fenseuse" vers "d√©fenseure"
         */
        function migratePlayerPositions() {
            const players = footballApp.getState().players;
            let hasChanges = false;
            
            players.forEach(player => {
                if (player.position === 'd√©fenseuse') {
                    player.position = 'd√©fenseure';
                    hasChanges = true;
                }
            });
            
            if (hasChanges) {
                footballApp.saveState();
                console.log('Migration des positions effectu√©e : d√©fenseuse ‚Üí d√©fenseure');
            }
        }

        function loadCurrentComposition() {
            const players = footballApp.getState().players;
            selectedPlayers = players.filter(p => p.status === 'field').map(p => p.id);
            
            players.forEach(player => {
                if (player.status !== 'field' && player.status !== 'sanctioned' && player.status !== 'out') {
                    footballApp.updatePlayerStatus(player.id, 'bench');
                }
            });
        }

        function loadPlayerPositions() {
            const saved = localStorage.getItem('footballStats_playerPositions');
            if (saved) {
                try {
                    playerPositions = JSON.parse(saved);
                } catch (e) {
                    playerPositions = {};
                }
            }
        }

        function savePlayerPositions() {
            localStorage.setItem('footballStats_playerPositions', JSON.stringify(playerPositions));
        }

        function togglePositioningMode() {
            positioningMode = !positioningMode;
            const btn = document.getElementById('togglePositioningBtn');
            const validateBtn = document.getElementById('validatePositioningBtn');
            const text = document.getElementById('positioningModeText');
            
            if (positioningMode) {
                btn.className = 'btn btn-success';
                btn.innerHTML = '‚úÖ Mode Positionnement Actif';
                validateBtn.style.display = 'inline-block';
                text.style.display = 'block';
                positioningValidated = false; // R√©initialiser la validation
            } else {
                btn.className = 'btn';
                btn.innerHTML = 'üéØ Mode Positionnement Manuel';
                validateBtn.style.display = 'none';
                text.style.display = 'none';
            }
            
            updateFormationDisplay();
        }

        function validatePositioning() {
            if (!positioningMode) return;
            
            // V√©rifier que toutes les joueuses s√©lectionn√©es sont positionn√©es
            const players = footballApp.getState().players;
            const selected = selectedPlayers.map(id => players.find(p => p.id === id)).filter(Boolean);
            const positionedCount = selected.filter(p => playerPositions[p.id]).length;
            
            if (positionedCount < selected.length) {
                const missing = selected.length - positionedCount;
                if (!confirm(`${missing} joueuse(s) ne sont pas encore positionn√©e(s). Valider quand m√™me ?`)) {
                    return;
                }
            }
            
            positioningValidated = true;
            positioningMode = false;
            
            const btn = document.getElementById('togglePositioningBtn');
            const validateBtn = document.getElementById('validatePositioningBtn');
            const text = document.getElementById('positioningModeText');
            
            btn.className = 'btn btn-warning';
            btn.innerHTML = 'üì∏ Positionnement Valid√©';
            btn.onclick = () => {
                if (confirm('Voulez-vous modifier le positionnement ?')) {
                    positioningValidated = false;
                    togglePositioningMode();
                }
            };
            
            validateBtn.style.display = 'none';
            text.style.display = 'none';
            
            updateFormationDisplay();
            showNotification('Positionnement valid√© ! Image fig√©e.', 'success');
        }

        function updatePlayersSelectionDisplay() {
            const container = document.getElementById('playersSelectionGrid');
            const players = footballApp.getState().players;

            if (players.length === 0) {
                container.innerHTML = '<p class="text-center">Aucune joueuse disponible. <a href="team.html">Cr√©ez votre √©quipe d\'abord</a>.</p>';
                return;
            }

            container.innerHTML = '';

            const positionsConfig = [
                { key: 'gardienne', label: 'Gardiennes', icon: 'ü•Ö' },
                { key: 'd√©fenseure', label: 'D√©fenseures', icon: 'üõ°Ô∏è' },
                { key: 'milieu', label: 'Milieux', icon: '‚öôÔ∏è' },
                { key: 'attaquante', label: 'Attaquantes', icon: '‚öΩ' }
            ];
            
            positionsConfig.forEach(posConfig => {
                const positionPlayers = players.filter(p => p.position === posConfig.key);
                
                if (positionPlayers.length > 0) {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'position-category';
                    
                    const headerDiv = document.createElement('div');
                    headerDiv.className = 'position-category-header';
                    headerDiv.innerHTML = `
                        <span class="position-category-icon">${posConfig.icon}</span>
                        <h3 class="position-category-title">${posConfig.label} (${positionPlayers.length})</h3>
                    `;
                    categoryDiv.appendChild(headerDiv);
                    
                    const playersDiv = document.createElement('div');
                    playersDiv.className = 'position-category-players';
                    
                    positionPlayers.forEach(player => {
                        const playerCard = createSelectablePlayerCard(player);
                        playersDiv.appendChild(playerCard);
                    });
                    
                    categoryDiv.appendChild(playersDiv);
                    container.appendChild(categoryDiv);
                }
            });
        }

        function createSelectablePlayerCard(player) {
            const isSelected = selectedPlayers.includes(player.id);
            const isDisabled = player.status === 'sanctioned';
            
            const card = document.createElement('div');
            card.className = `player-btn ${player.position === 'gardienne' ? 'goalkeeper' : ''} ${isSelected ? 'selected' : ''} ${isDisabled ? 'sanctioned' : ''}`;
            
            if (isDisabled) {
                card.style.opacity = '0.5';
                card.style.cursor = 'not-allowed';
            } else {
                card.onclick = () => togglePlayerSelection(player.id);
            }

            card.innerHTML = `
                <div style="font-size: 1.5em;">${footballApp.getPositionIcon(player.position)}</div>
                <div style="font-weight: bold; margin: 5px 0;">${player.name}</div>
                ${player.number ? `<div style="font-size: 12px; color: #f39c12;">N¬∞ ${player.number}</div>` : ''}
                <div style="font-size: 11px; margin: 5px 0;">
                    ${isSelected ? '‚úÖ Titulaire' : isDisabled ? '‚ö†Ô∏è Sanctionn√©e' : 'ü™ë Disponible'}
                </div>
                <div style="font-size: 10px; opacity: 0.8;">
                    ‚öΩ ${player.stats.goals} | üéØ ${player.stats.shots}
                </div>
            `;

            return card;
        }

        function togglePlayerSelection(playerId) {
            const player = footballApp.getState().players.find(p => p.id === playerId);
            
            if (!player || player.status === 'sanctioned') {
                return;
            }

            const isSelected = selectedPlayers.includes(playerId);
            
            if (isSelected) {
                selectedPlayers = selectedPlayers.filter(id => id !== playerId);
                footballApp.updatePlayerStatus(playerId, 'bench');
            } else {
                if (selectedPlayers.length >= 11) {
                    showNotification('Vous avez d√©j√† s√©lectionn√© 11 joueuses', 'warning');
                    return;
                }
                
                if (player.position === 'gardienne') {
                    const selectedGoalkeepers = selectedPlayers.filter(id => {
                        const p = footballApp.getState().players.find(pl => pl.id === id);
                        return p && p.position === 'gardienne';
                    });
                    
                    if (selectedGoalkeepers.length > 0) {
                        showNotification('Il ne peut y avoir qu\'une seule gardienne titulaire', 'warning');
                        return;
                    }
                }
                
                selectedPlayers.push(playerId);
                footballApp.updatePlayerStatus(playerId, 'field');
            }

            updatePlayersSelectionDisplay();
            updateCompositionStats();
            updateFormationDisplay();
            updateValidationButton();
        }

        function updateCompositionStats() {
            const players = footballApp.getState().players;
            const selected = selectedPlayers.map(id => players.find(p => p.id === id)).filter(Boolean);
            
            document.getElementById('selectedCount').textContent = selected.length;
            document.getElementById('goalkeepersSelected').textContent = selected.filter(p => p.position === 'gardienne').length;
            document.getElementById('defendersSelected').textContent = selected.filter(p => p.position === 'd√©fenseure').length;
            document.getElementById('midfieldersSelected').textContent = selected.filter(p => p.position === 'milieu').length;
            document.getElementById('attackersSelected').textContent = selected.filter(p => p.position === 'attaquante').length;
            
            updateCompositionStatus(selected);
        }

        function updateCompositionStatus(selected) {
            const statusEl = document.getElementById('compositionStatus');
            const goalkeepers = selected.filter(p => p.position === 'gardienne').length;
            
            if (selected.length === 0) {
                statusEl.innerHTML = '<span class="status-icon">‚ö†Ô∏è</span><span class="status-text">Aucune joueuse s√©lectionn√©e</span>';
                statusEl.className = 'composition-status warning';
            } else if (selected.length < 11) {
                statusEl.innerHTML = `<span class="status-icon">‚ö†Ô∏è</span><span class="status-text">Il manque ${11 - selected.length} joueuse(s)</span>`;
                statusEl.className = 'composition-status warning';
            } else if (selected.length === 11 && goalkeepers === 0) {
                statusEl.innerHTML = '<span class="status-icon">‚ùå</span><span class="status-text">Aucune gardienne s√©lectionn√©e</span>';
                statusEl.className = 'composition-status error';
            } else if (selected.length === 11 && goalkeepers === 1) {
                statusEl.innerHTML = '<span class="status-icon">‚úÖ</span><span class="status-text">Composition valide et pr√™te !</span>';
                statusEl.className = 'composition-status success';
            } else {
                statusEl.innerHTML = '<span class="status-icon">‚ùå</span><span class="status-text">Trop de joueuses s√©lectionn√©es</span>';
                statusEl.className = 'composition-status error';
            }
        }

        function updateFormationDisplay() {
            const players = footballApp.getState().players;
            const selected = selectedPlayers.map(id => players.find(p => p.id === id)).filter(Boolean);
            
            const positions = {
                gardienne: selected.filter(p => p.position === 'gardienne'),
                d√©fenseure: selected.filter(p => p.position === 'd√©fenseure'),
                milieu: selected.filter(p => p.position === 'milieu'),
                attaquante: selected.filter(p => p.position === 'attaquante')
            };

            if (positioningMode || positioningValidated) {
                updatePositionDisplayManual('gk', positions.gardienne, 1);
                updatePositionDisplayManual('def', positions.d√©fenseure, 5);
                updatePositionDisplayManual('mid', positions.milieu, 5);
                updatePositionDisplayManual('att', positions.attaquante, 3);
            } else {
                updatePositionDisplay('gk', positions.gardienne);
                updatePositionDisplay('def', positions.d√©fenseure);
                updatePositionDisplay('mid', positions.milieu);
                updatePositionDisplay('att', positions.attaquante);
            }
            
            updateStartingElevenList(selected);
            updateBenchList();
        }

        function updatePositionDisplay(position, players) {
            const container = document.getElementById(`${position}-players`);
            
            if (players.length === 0) {
                container.innerHTML = '<div class="empty-position">Aucune joueuse</div>';
                return;
            }

            container.innerHTML = '';
            players.forEach(player => {
                const playerEl = document.createElement('div');
                playerEl.className = 'field-player';
                playerEl.innerHTML = `
                    <div class="player-name">${player.name}</div>
                    ${player.number ? `<div class="player-number">${player.number}</div>` : ''}
                `;
                container.appendChild(playerEl);
            });
        }

        function updatePositionDisplayManual(position, players, maxSlots) {
            const container = document.getElementById(`${position}-players`);
            container.innerHTML = '';
            container.style.display = 'flex';
            container.style.justifyContent = 'center';
            container.style.gap = '10px';
            container.style.flexWrap = 'wrap';
            
            for (let i = 0; i < maxSlots; i++) {
                const slotId = `${position}-${i}`;
                const assignedPlayer = players.find(p => playerPositions[p.id] === slotId);
                
                // Si le positionnement est valid√© et l'emplacement est vide, on ne l'affiche pas
                if (positioningValidated && !assignedPlayer) {
                    continue;
                }
                
                const slotDiv = document.createElement('div');
                slotDiv.className = 'position-slot' + (assignedPlayer ? ' filled' : ' empty');
                slotDiv.id = slotId;
                
                if (assignedPlayer) {
                    slotDiv.innerHTML = `
                        <div class="player-name">${assignedPlayer.name}</div>
                        ${assignedPlayer.number ? `<div class="player-number">${assignedPlayer.number}</div>` : ''}
                    `;
                    if (positioningMode) {
                        slotDiv.onclick = () => reassignPlayerSlot(slotId, position, assignedPlayer.id);
                    }
                } else {
                    slotDiv.innerHTML = '<div class="empty-slot">+</div>';
                    slotDiv.onclick = () => assignPlayerToSlot(slotId, position);
                }
                
                container.appendChild(slotDiv);
            }
        }

        function assignPlayerToSlot(slotId, positionType) {
            if (!positioningMode) return;
            
            const players = footballApp.getState().players;
            const positionKey = positionType === 'gk' ? 'gardienne' : 
                               positionType === 'def' ? 'd√©fenseure' :
                               positionType === 'mid' ? 'milieu' : 'attaquante';
            
            const availablePlayers = selectedPlayers
                .map(id => players.find(p => p.id === id))
                .filter(p => p && p.position === positionKey && !playerPositions[p.id]);
            
            if (availablePlayers.length === 0) {
                showNotification('Aucune joueuse disponible pour cette position', 'warning');
                return;
            }
            
            showPlayerSelectionModal(availablePlayers, slotId);
        }

        function reassignPlayerSlot(slotId, positionType, currentPlayerId) {
            if (!positioningMode) return;
            
            if (confirm('Voulez-vous retirer cette joueuse de cet emplacement ?')) {
                delete playerPositions[currentPlayerId];
                savePlayerPositions();
                updateFormationDisplay();
            }
        }

        function showPlayerSelectionModal(availablePlayers, slotId) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h3>S√©lectionner une joueuse</h3>
                    <div class="player-selection-list">
                        ${availablePlayers.map(player => `
                            <button class="player-select-btn" onclick="confirmPlayerAssignment('${player.id}', '${slotId}', this.closest('.modal'))">
                                ${footballApp.getPositionIcon(player.position)} ${player.name}
                                ${player.number ? ` (${player.number})` : ''}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function confirmPlayerAssignment(playerId, slotId, modal) {
            playerPositions[playerId] = slotId;
            savePlayerPositions();
            modal.remove();
            updateFormationDisplay();
            showNotification('Joueuse positionn√©e !', 'success');
        }

        function updateStartingElevenList(selected) {
            const container = document.getElementById('startingElevenList');
            
            if (selected.length === 0) {
                container.innerHTML = '<p>Aucune joueuse s√©lectionn√©e</p>';
                return;
            }

            container.innerHTML = '';
            
            const positionsConfig = [
                { key: 'gardienne', label: 'Gardiennes', icon: 'ü•Ö' },
                { key: 'd√©fenseure', label: 'D√©fenseures', icon: 'üõ°Ô∏è' },
                { key: 'milieu', label: 'Milieux', icon: '‚öôÔ∏è' },
                { key: 'attaquante', label: 'Attaquantes', icon: '‚öΩ' }
            ];
            
            positionsConfig.forEach(posConfig => {
                const positionPlayers = selected.filter(p => p.position === posConfig.key);
                
                if (positionPlayers.length > 0) {
                    const positionDiv = document.createElement('div');
                    positionDiv.className = 'position-group';
                    positionDiv.innerHTML = `
                        <h4>${posConfig.icon} ${posConfig.label} (${positionPlayers.length})</h4>
                        <ul>
                            ${positionPlayers.map(p => `<li>${p.name}${p.number ? ` (${p.number})` : ''}</li>`).join('')}
                        </ul>
                    `;
                    container.appendChild(positionDiv);
                }
            });
        }

        function updateBenchList() {
            const container = document.getElementById('benchList');
            const players = footballApp.getState().players;
            
            const benchPlayers = players.filter(p => 
                p.status === 'bench' || 
                (p.status !== 'field' && p.status !== 'sanctioned' && p.status !== 'out')
            );
            
            if (benchPlayers.length === 0) {
                container.innerHTML = '<p>Aucune joueuse sur le banc</p>';
                return;
            }

            container.innerHTML = '';
            const benchList = document.createElement('ul');
            
            benchPlayers.forEach(player => {
                const li = document.createElement('li');
                li.innerHTML = `${footballApp.getPositionIcon(player.position)} ${player.name}${player.number ? ` (${player.number})` : ''}`;
                benchList.appendChild(li);
            });
            
            container.appendChild(benchList);
        }

        function updateValidationButton() {
            const btn = document.getElementById('validateBtn');
            const players = footballApp.getState().players;
            const selected = selectedPlayers.map(id => players.find(p => p.id === id)).filter(Boolean);
            const goalkeepers = selected.filter(p => p.position === 'gardienne').length;
            
            const isValid = selected.length === 11 && goalkeepers === 1;
            btn.disabled = !isValid;
            
            if (isValid) {
                btn.className = 'btn btn-success';
                btn.innerHTML = '‚úÖ Valider la Composition';
            } else {
                btn.className = 'btn btn-primary';
                btn.innerHTML = '‚ö†Ô∏è Composition Incompl√®te';
            }
        }

        function clearSelection() {
            if (selectedPlayers.length === 0) {
                showNotification('Aucune joueuse √† d√©s√©lectionner', 'info');
                return;
            }

            if (confirm('D√©s√©lectionner toutes les joueuses ?')) {
                selectedPlayers.forEach(playerId => {
                    footballApp.updatePlayerStatus(playerId, 'bench');
                });
                
                selectedPlayers = [];
                
                updatePlayersSelectionDisplay();
                updateCompositionStats();
                updateFormationDisplay();
                updateValidationButton();
                
                showNotification('S√©lection effac√©e');
            }
        }

        function autoSelectComposition() {
            const players = footballApp.getState().players;
            const availablePlayers = players.filter(p => p.status !== 'sanctioned');
            
            if (availablePlayers.length < 11) {
                showNotification(`Il faut au moins 11 joueuses disponibles (${availablePlayers.length} actuellement)`, 'error');
                return;
            }

            const goalkeepers = availablePlayers.filter(p => p.position === 'gardienne');
            if (goalkeepers.length === 0) {
                showNotification('Aucune gardienne disponible', 'error');
                return;
            }

            if (confirm('S√©lectionner automatiquement une composition √©quilibr√©e ?')) {
                selectedPlayers.forEach(playerId => {
                    footballApp.updatePlayerStatus(playerId, 'bench');
                });
                selectedPlayers = [];

                const selected = [];
                selected.push(goalkeepers[0]);

                const fieldPlayers = availablePlayers.filter(p => p.position !== 'gardienne');
                const distribution = { d√©fenseure: 4, milieu: 3, attaquante: 3 };
                
                ['d√©fenseure', 'milieu', 'attaquante'].forEach(position => {
                    const positionPlayers = fieldPlayers.filter(p => p.position === position);
                    const needed = distribution[position];
                    
                    for (let i = 0; i < Math.min(needed, positionPlayers.length); i++) {
                        if (selected.length < 11) {
                            selected.push(positionPlayers[i]);
                        }
                    }
                });

                while (selected.length < 11 && fieldPlayers.length > 0) {
                    const remaining = fieldPlayers.filter(p => !selected.includes(p));
                    if (remaining.length > 0) {
                        selected.push(remaining[0]);
                    } else {
                        break;
                    }
                }

                selected.forEach(player => {
                    selectedPlayers.push(player.id);
                    footballApp.updatePlayerStatus(player.id, 'field');
                });

                updatePlayersSelectionDisplay();
                updateCompositionStats();
                updateFormationDisplay();
                updateValidationButton();
                
                showNotification(`Composition automatique cr√©√©e (${selected.length} joueuses)`);
            }
        }

        function applyFormation(formation) {
            const players = footballApp.getState().players;
            const availablePlayers = players.filter(p => p.status !== 'sanctioned');
            
            const formations = {
                '4-4-2': { d√©fenseure: 4, milieu: 4, attaquante: 2 },
                '4-3-3': { d√©fenseure: 4, milieu: 3, attaquante: 3 },
                '4-2-3-1': { d√©fenseure: 4, milieu: 5, attaquante: 1 },
                '3-5-2': { d√©fenseure: 3, milieu: 5, attaquante: 2 },
                '5-3-2': { d√©fenseure: 5, milieu: 3, attaquante: 2 }
            };

            const config = formations[formation];
            if (!config) return;

            const goalkeepers = availablePlayers.filter(p => p.position === 'gardienne');
            if (goalkeepers.length === 0) {
                showNotification('Aucune gardienne disponible', 'error');
                return;
            }

            let canApply = true;
            let message = `Formation ${formation}:\n`;
            
            const positionLabels = {
                'd√©fenseure': 'D√©fenseures',
                'milieu': 'Milieux',
                'attaquante': 'Attaquantes'
            };
            
            Object.entries(config).forEach(([position, needed]) => {
                const available = availablePlayers.filter(p => p.position === position).length;
                const label = positionLabels[position] || position;
                message += `- ${label}: ${needed} requis, ${available} disponibles\n`;
                if (available < needed) {
                    canApply = false;
                }
            });

            if (!canApply) {
                alert(`Impossible d'appliquer la formation ${formation}:\n\n${message}`);
                return;
            }

            if (confirm(`Appliquer la formation ${formation} ?\n\n${message}`)) {
                selectedPlayers.forEach(playerId => {
                    footballApp.updatePlayerStatus(playerId, 'bench');
                });
                selectedPlayers = [];

                const selected = [];
                selected.push(goalkeepers[0]);
                
                Object.entries(config).forEach(([position, needed]) => {
                    const positionPlayers = availablePlayers.filter(p => p.position === position);
                    for (let i = 0; i < needed && i < positionPlayers.length; i++) {
                        selected.push(positionPlayers[i]);
                    }
                });

                selected.forEach(player => {
                    selectedPlayers.push(player.id);
                    footballApp.updatePlayerStatus(player.id, 'field');
                });

                updatePlayersSelectionDisplay();
                updateCompositionStats();
                updateFormationDisplay();
                updateValidationButton();
                
                showNotification(`Formation ${formation} appliqu√©e !`);
            }
        }

        function validateComposition() {
            const players = footballApp.getState().players;
            const selected = selectedPlayers.map(id => players.find(p => p.id === id)).filter(Boolean);
            const goalkeepers = selected.filter(p => p.position === 'gardienne').length;
            
            if (selected.length !== 11) {
                showNotification(`Il faut exactement 11 joueuses (${selected.length} s√©lectionn√©es)`, 'error');
                return;
            }

            if (goalkeepers !== 1) {
                showNotification('Il faut exactement 1 gardienne', 'error');
                return;
            }

            footballApp.saveState();
            displayValidationSummary(selected);
            document.getElementById('validationModal').style.display = 'block';
        }

        function displayValidationSummary(selected) {
            const container = document.getElementById('validatedComposition');
            
            const positions = {
                gardienne: selected.filter(p => p.position === 'gardienne'),
                d√©fenseure: selected.filter(p => p.position === 'd√©fenseure'),
                milieu: selected.filter(p => p.position === 'milieu'),
                attaquante: selected.filter(p => p.position === 'attaquante')
            };

            const formation = `${positions.d√©fenseure.length}-${positions.milieu.length}-${positions.attaquante.length}`;

            container.innerHTML = `
                <div class="formation-summary">
                    <h4>Formation: ${formation}</h4>
                    <div class="position-summary">
                        <div><strong>ü•Ö Gardienne:</strong> ${positions.gardienne.map(p => p.name).join(', ')}</div>
                        <div><strong>üõ°Ô∏è D√©fense (${positions.d√©fenseure.length}):</strong> ${positions.d√©fenseure.map(p => p.name).join(', ')}</div>
                        <div><strong>‚öôÔ∏è Milieux (${positions.milieu.length}):</strong> ${positions.milieu.map(p => p.name).join(', ')}</div>
                        <div><strong>‚öΩ Attaque (${positions.attaquante.length}):</strong> ${positions.attaquante.map(p => p.name).join(', ')}</div>
                    </div>
                </div>
            `;
        }

        function closeValidationModal() {
            document.getElementById('validationModal').style.display = 'none';
        }

        function goToMatch() {
            showNotification('Redirection vers l\'interface de match...', 'success');
            setTimeout(() => {
                window.location.href = 'match.html';
            }, 1500);
        }

        function showNotification(message, type = 'info') {
            if (typeof footballApp !== 'undefined' && footballApp.showNotification) {
                footballApp.showNotification(message, type);
            } else {
                alert(message);
            }
        }
    </script>
</body>
</html>