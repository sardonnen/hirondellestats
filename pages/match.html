<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match - Football Stats</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚öΩ</text></svg>">
    <style>
        /* Styles sp√©cifiques pour la page match */
        
        /* Styles pour le header du match */
        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .team-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .team-name {
            font-size: 1.2em;
            font-weight: bold;
            color: white;
        }
        
        .team-score {
            font-size: 3em;
            font-weight: bold;
            color: #3498db;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .match-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .match-time {
            font-size: 2.5em;
            font-weight: bold;
            color: #f39c12;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .match-half {
            font-size: 1.1em;
            color: #ecf0f1;
            margin-bottom: 15px;
        }
        
        .timer-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .timer-controls .btn {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        .action-btn {
            padding: 20px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 16px;
            font-weight: 500;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        
        .action-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .action-btn.goal { background: rgba(39, 174, 96, 0.2); border-color: #27ae60; }
        .action-btn.shot { background: rgba(52, 152, 219, 0.2); border-color: #3498db; }
        .action-btn.card { background: rgba(243, 156, 18, 0.2); border-color: #f39c12; }
        .action-btn.foul { background: rgba(231, 76, 60, 0.2); border-color: #e74c3c; }
        .action-btn.save { background: rgba(230, 126, 34, 0.2); border-color: #e67e22; }
        .action-btn.freekick { background: rgba(155, 89, 182, 0.2); border-color: #9b59b6; }
        
        .team-choice-modal .modal-content {
            max-width: 400px;
        }
        
        .team-choice-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .team-choice-btn {
            padding: 20px 30px;
            border: 3px solid;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
            font-weight: bold;
            min-width: 120px;
            text-align: center;
        }
        
        .team-choice-btn.my-team {
            background: rgba(39, 174, 96, 0.2);
            border-color: #27ae60;
            color: white;
        }
        
        .team-choice-btn.opponent-team {
            background: rgba(231, 76, 60, 0.2);
            border-color: #e74c3c;
            color: white;
        }
        
        .team-choice-btn.selected {
            background: white !important;
            color: #2c3e50 !important;
            transform: scale(1.05);
        }
        
        .player-btn.selected {
            background: rgba(255, 255, 255, 0.5) !important;
            color: #2c3e50 !important;
            border-color: #27ae60 !important;
            backdrop-filter: blur(5px);
        }
        
        .goalkeeper-choice-btn {
            padding: 20px 30px;
            border: 3px solid;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
            font-weight: bold;
            min-width: 120px;
            text-align: center;
            margin: 10px;
        }
        
        .goalkeeper-choice-btn.my-gk {
            background: rgba(230, 126, 34, 0.3);
            border-color: #e67e22;
            color: white;
        }
        
        .goalkeeper-choice-btn.opponent-gk {
            background: rgba(231, 76, 60, 0.3);
            border-color: #e74c3c;
            color: white;
        }
        
        .goalkeeper-choice-btn.selected {
            background: rgba(255, 255, 255, 0.5) !important;
            color: #2c3e50 !important;
            transform: scale(1.05);
            backdrop-filter: blur(5px);
        }
        
        .save-type-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        .save-type-btn {
            padding: 15px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 16px;
        }
        
        .save-type-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }
        
        .save-type-btn.selected {
            background: rgba(255, 255, 255, 0.5) !important;
            color: #2c3e50 !important;
            border-color: #27ae60 !important;
            backdrop-filter: blur(5px);
        }
        
        .global-stats-compact {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .compact-stat-card {
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }
        
        .compact-stat-card:hover {
            background: rgba(255,255,255,0.15);
            transform: translateY(-3px);
        }
        
        .compact-stat-icon {
            font-size: 2em;
            margin-bottom: 8px;
        }
        
        .compact-stat-values {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
        }
        
        .compact-team-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #3498db;
        }
        
        .compact-separator {
            font-size: 1.2em;
            color: #bdc3c7;
        }
        
        .compact-opponent-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #e74c3c;
        }
        
        .compact-stat-label {
            font-size: 0.9em;
            color: #ecf0f1;
            opacity: 0.9;
        }
        
        .timeline-container {
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .timeline-header {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: bold;
            text-align: center;
        }
        
        .timeline-event {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            align-items: center;
        }
        
        .timeline-event:last-child {
            border-bottom: none;
        }
        
        .event-left, .event-right {
            padding: 8px 12px;
            border-radius: 6px;
        }
        
        .event-left {
            text-align: right;
            background: rgba(39, 174, 96, 0.3);
        }
        
        .event-right {
            text-align: left;
            background: rgba(231, 76, 60, 0.3);
        }
        
        .event-time {
            background: rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: bold;
            text-align: center;
            min-width: 60px;
        }
        
        .assist-selection {
            margin: 15px 0;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        
        .assist-selection h4 {
            margin-bottom: 10px;
            color: #f39c12;
        }

        /* AJOUT POUR LES BOUTONS DE RESET - STYLES DISCRETS */
        .timeline-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .timeline-controls .btn {
            padding: 8px 16px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Bouton Live fixe -->
        <div class="live-link">
            <button class="btn btn-primary" onclick="generateLiveLink()">üì° Lien Live</button>
        </div>

        <header class="header">
            <h1>‚öΩ Interface de Match</h1>
            <p>Suivez et enregistrez tous les √©v√©nements du match</p>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <a href="../index.html" class="nav-link">üè† Accueil</a>
            <a href="team.html" class="nav-link">üë• √âquipe</a>
            <a href="composition.html" class="nav-link">üìã Compo</a>
            <a href="match.html" class="nav-link active">‚öΩ Match</a>
            <a href="live.html" class="nav-link">üì∫ Live</a>
            <a href="stats.html" class="nav-link">üìä Stats</a>
        </nav>

        <!-- Contenu principal -->
        <main class="main-content">
            
            <!-- Tableau de bord du match -->
            <div class="team-card">
                <div class="match-header">
                    <div class="team-info">
                        <div class="team-name" id="teamName">Mon √âquipe</div>
                        <div class="team-score" id="teamScore">0</div>
                    </div>
                    
                    <div class="match-info">
                        <div class="match-time" id="matchTime">00:00</div>
                        <div class="match-half" id="matchHalf">1√®re Mi-temps</div>
                        <div class="timer-controls">
                            <button class="btn btn-success" id="playBtn" onclick="toggleTimer()">‚ñ∂Ô∏è D√©marrer</button>
                            <button class="btn btn-warning" onclick="resetTimer()">üîÑ Reset</button>
                            <button class="btn btn-primary" onclick="showHalfTimeConfirm()">‚≠ê Mi-temps</button>
                        </div>
                    </div>
                    
                    <div class="team-info">
                        <div class="team-name" id="opponentName">√âquipe Adverse</div>
                        <div class="team-score" id="opponentScore">0</div>
                    </div>
                </div>
            </div>

            <!-- Actions de jeu - Grille 3x3 -->
            <div class="team-card">
                <h3>‚öΩ Actions de Jeu</h3>
                <div class="action-buttons" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <button class="action-btn goal" onclick="showUnifiedActionModal('goal')">
                        ‚öΩ But
                    </button>
                    <button class="action-btn assist" onclick="showUnifiedActionModal('assist')">
                        ‚û°Ô∏è Passe D√©cisive
                    </button>
                    <button class="action-btn shot" onclick="showUnifiedActionModal('shot')">
                        üéØ Tir
                    </button>
                    <button class="action-btn save" onclick="showUnifiedActionModal('save')">
                        üß§ Arr√™t Gardien
                    </button>
                    <button class="action-btn foul" onclick="showUnifiedActionModal('foul')">
                        ‚ö†Ô∏è Faute
                    </button>
                    <button class="action-btn card" onclick="showUnifiedActionModal('card')">
                        üü® Carton
                    </button>
                    <button class="action-btn corner" onclick="showUnifiedActionModal('corner')">
                        üö© Corner
                    </button>
                    <button class="action-btn offside" onclick="showUnifiedActionModal('offside')">
                        üõë Hors-jeu
                    </button>
                    <button class="action-btn substitution" onclick="showSubstitutionModal()">
                        üîÑ Changement
                    </button>
                </div>
            </div>

            <!-- Zone timers carton blanc (entre boutons reset et timeline) -->
            <div id="whiteCardTimersZone" class="white-card-timers" style="margin: 20px 0; display: none;">
                <h4>‚è±Ô∏è Cartons Blancs Actifs</h4>
                <div id="whiteCardTimersList" style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <!-- Les timers s'affichent ici -->
                </div>
            </div>

            <!-- Modal Unified Action -->
            <div id="unifiedActionModal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeUnifiedActionModal()">&times;</span>
                    <h3 id="unifiedActionTitle">Action</h3>
                    
                    <!-- Options sp√©cifiques (affich√©es selon le type d'action) -->
                    <div id="actionOptionsZone" style="display: none; margin-bottom: 20px;">
                        <div id="actionOptionsButtons" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;">
                            <!-- Les boutons d'options s'affichent ici -->
                        </div>
                    </div>
                    
                    <!-- Joueurs de l'√©quipe sur le terrain -->
                    <div id="teamPlayersZone" style="margin-bottom: 15px;">
                        <h4>Mon √âquipe</h4>
                        <div id="teamPlayerButtons" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                            <!-- Boutons joueurs -->
                        </div>
                    </div>
                    
                    <!-- Bouton adversaire -->
                    <div style="margin-bottom: 15px;">
                        <button id="opponentBtn" class="player-btn opponent-choice" onclick="selectOpponent()" style="width: 100%; padding: 15px; font-size: 1.1em;">
                            üî¥ Adversaire
                        </button>
                    </div>
                    
                    <div class="modal-actions">
                        <button id="saveUnifiedActionBtn" class="btn btn-primary" disabled onclick="saveUnifiedAction()">üíæ Enregistrer</button>
                        <button class="btn btn-secondary" onclick="closeUnifiedActionModal()">‚ùå Annuler</button>
                    </div>
                </div>
            </div>

            <!-- Modal Changement (sp√©ciale) -->
            <div id="substitutionModal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeSubstitutionModal()">&times;</span>
                    <h3>üîÑ Changement de Joueuse</h3>
                    
                    <!-- Choix: Mon √©quipe ou Adversaire -->
                    <div style="margin-bottom: 20px;">
                        <button id="subMyTeamBtn" class="btn" onclick="selectSubstitutionTeam('myTeam')" style="width: 48%; margin-right: 4%;">
                            üü¢ Mon √âquipe
                        </button>
                        <button id="subOpponentBtn" class="btn" onclick="selectSubstitutionTeam('opponent')" style="width: 48%;">
                            üî¥ Adversaire
                        </button>
                    </div>
                    
                    <!-- Section Mon √âquipe (cach√©e si adversaire) -->
                    <div id="myTeamSubSection" style="display: none;">
                        <div style="margin-bottom: 15px;">
                            <h4>Joueuse qui sort (sur le terrain)</h4>
                            <div id="playerOutButtons" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                <!-- Joueurs sur terrain -->
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <h4>Joueuse qui entre (sur le banc)</h4>
                            <div id="playerInButtons" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                                <!-- Joueurs sur banc -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-actions">
                        <button id="saveSubstitutionBtn" class="btn btn-primary" disabled onclick="saveSubstitution()">üíæ Enregistrer</button>
                        <button class="btn btn-secondary" onclick="closeSubstitutionModal()">‚ùå Annuler</button>
                    </div>
                </div>
            </div>

            <style>
            /* Styles pour les s√©lections */
            .player-btn.selected {
                background: rgba(255, 255, 255, 0.5) !important;
                border: 3px solid #4CAF50 !important;
            }

            .option-btn.selected {
                background: rgba(255, 255, 255, 0.5) !important;
                border: 3px solid #2196F3 !important;
            }

            .opponent-choice.selected {
                background: rgba(255, 255, 255, 0.5) !important;
                border: 3px solid #f44336 !important;
            }

            /* Timers carton blanc */
            .white-card-timer {
                background: rgba(255, 255, 255, 0.1);
                padding: 10px 15px;
                border-radius: 8px;
                border: 2px solid #fff;
                min-width: 200px;
            }

            .white-card-timer .timer-name {
                font-weight: bold;
                margin-bottom: 5px;
            }

            .white-card-timer .timer-countdown {
                font-size: 1.5em;
                color: #ffd700;
            }

            .white-card-timer.expired {
                border-color: #4CAF50;
                opacity: 0.6;
            }
            </style>

            <!-- Timeline des √©v√©nements -->
            <div class="team-card">
                <h3>üìù Timeline du Match</h3>
                <!-- AJOUT DES BOUTONS DE RESET -->
                <div class="timeline-controls">
                    <button class="btn btn-primary" onclick="newMatchFromMatchPage()">üÜï Nouveau Match</button>
                    <button class="btn btn-danger" onclick="resetAllFromMatchPage()">üîÑ Reset Complet</button>
                </div>
                <div class="timeline-container">
                    <div class="timeline-header">
                        <div>Mon √âquipe</div>
                        <div>Temps</div>
                        <div>√âquipe Adverse</div>
                    </div>
                    <div id="eventsTimeline" class="timeline-events">
                        <div style="text-align: center; padding: 20px; color: #bbb;">
                            Aucun √©v√©nement enregistr√©
                        </div>
                    </div>
                </div>
            </div>

            <!-- R√©sum√© rapide -->
            <div class="team-card">
                <h3>üìä R√©sum√© Rapide</h3>
                <div class="global-stats-compact">
                    <div class="compact-stat-card goals">
                        <div class="compact-stat-icon">‚öΩ</div>
                        <div class="compact-stat-values">
                            <span class="compact-team-value" id="compactTeamGoals">0</span>
                            <span class="compact-separator">-</span>
                            <span class="compact-opponent-value" id="compactOpponentGoals">0</span>
                        </div>
                        <div class="compact-stat-label">Buts</div>
                    </div>
                    
                    <div class="compact-stat-card shots">
                        <div class="compact-stat-icon">üéØ</div>
                        <div class="compact-stat-values">
                            <span class="compact-team-value" id="compactTeamShots">0</span>
                            <span class="compact-separator">-</span>
                            <span class="compact-opponent-value" id="compactOpponentShots">0</span>
                        </div>
                        <div class="compact-stat-label">Tirs</div>
                    </div>
                    
                    <div class="compact-stat-card cards">
                        <div class="compact-stat-icon">üü®</div>
                        <div class="compact-stat-values">
                            <span class="compact-team-value" id="compactTeamCards">0</span>
                            <span class="compact-separator">-</span>
                            <span class="compact-opponent-value" id="compactOpponentCards">0</span>
                        </div>
                        <div class="compact-stat-label">Cartons</div>
                    </div>
                    
                    <div class="compact-stat-card fouls">
                        <div class="compact-stat-icon">‚ö†Ô∏è</div>
                        <div class="compact-stat-values">
                            <span class="compact-team-value" id="compactTeamFouls">0</span>
                            <span class="compact-separator">-</span>
                            <span class="compact-opponent-value" id="compactOpponentFouls">0</span>
                        </div>
                        <div class="compact-stat-label">Fautes</div>
                    </div>
                    
                    <div class="compact-stat-card saves">
                        <div class="compact-stat-icon">üß§</div>
                        <div class="compact-stat-values">
                            <span class="compact-team-value" id="compactTeamSaves">0</span>
                            <span class="compact-separator">-</span>
                            <span class="compact-opponent-value" id="compactOpponentSaves">0</span>
                        </div>
                        <div class="compact-stat-label">Arr√™ts</div>
                    </div>
                    
                    <div class="compact-stat-card freekicks">
                        <div class="compact-stat-icon">‚öΩ</div>
                        <div class="compact-stat-values">
                            <span class="compact-team-value" id="compactTeamFreeKicks">0</span>
                            <span class="compact-separator">-</span>
                            <span class="compact-opponent-value" id="compactOpponentFreeKicks">0</span>
                        </div>
                        <div class="compact-stat-label">Coups Francs</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Action -->
    <div id="actionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeActionModal()">&times;</span>
            <h3 id="actionModalTitle">Action</h3>
            
            <!-- S√©lection du type de carton -->
            <div id="cardButtons" class="card-buttons" style="display: none;">
                <button class="card-btn yellow-card" onclick="selectCardType('yellow')">üü® Jaune</button>
                <button class="card-btn red-card" onclick="selectCardType('red')">üü• Rouge</button>
                <button class="card-btn white-card" onclick="selectCardType('white')">‚ö™ Blanc (10min)</button>
            </div>
            
            <!-- S√©lection pour la passe d√©cisive (buts seulement) -->
            <div id="assistSelection" class="assist-selection" style="display: none;">
                <h4>‚û°Ô∏è Passe d√©cisive (optionnel):</h4>
                <div id="assistPlayerButtons" class="player-grid">
                    <!-- Boutons pour la passe d√©cisive -->
                </div>
            </div>
            
            <!-- S√©lection du joueur -->
            <div id="actionPlayerButtons" class="player-grid">
                <!-- Boutons des joueuses -->
            </div>
            
            <div class="modal-actions">
                <button id="saveActionBtn" class="btn btn-primary" disabled onclick="saveAction()">üíæ Enregistrer</button>
                <button class="btn btn-secondary" onclick="closeActionModal()">‚ùå Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal Gardien -->
    <div id="goalkeeperModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeGoalkeeperModal()">&times;</span>
            <h3>üß§ Arr√™t de Gardien</h3>
            
            <!-- Choix du gardien -->
            <div class="goalkeeper-choice-section">
                <h4>Qui a fait l'arr√™t ?</h4>
                <div class="goalkeeper-choices">
                    <div class="goalkeeper-choice-btn my-gk" onclick="selectGoalkeeperTeam('my-team')">
                        üü¢ <span id="myGoalkeeperName">Mon Gardien</span>
                    </div>
                    <div class="goalkeeper-choice-btn opponent-gk" onclick="selectGoalkeeperTeam('opponent')">
                        üî¥ Gardien Adverse
                    </div>
                </div>
            </div>
            
            <!-- Types d'arr√™t -->
            <div class="save-type-section" id="saveTypeSection" style="display: none;">
                <h4>Type d'arr√™t :</h4>
                <div class="save-type-buttons">
                    <div class="save-type-btn" onclick="selectSaveType('line')" data-type="line">
                        ü•Ö Sur sa ligne
                    </div>
                    <div class="save-type-btn" onclick="selectSaveType('out')" data-type="out">
                        üèÉ‚Äç‚ôÄÔ∏è En sortie
                    </div>
                    <div class="save-type-btn" onclick="selectSaveType('penalty')" data-type="penalty">
                        ‚öΩ Penalty
                    </div>
                    <div class="save-type-btn" onclick="selectSaveType('corner')" data-type="corner">
                        üö© Corner
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button id="saveGoalkeeperBtn" class="btn btn-primary" disabled onclick="saveGoalkeeperAction()">üíæ Enregistrer</button>
                <button class="btn btn-secondary" onclick="closeGoalkeeperModal()">‚ùå Annuler</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/storage.js"></script>
    <script src="../js/app.js"></script>
    <script src="../js/match_actions.js"></script>
    <script>
        // Variables locales de la page match
        let selectedAssistPlayerId = null;
        let selectedTeam = null;
        let selectedOutPlayer = null;
        let selectedInPlayer = null;
        let selectedSavePlayer = null;
        let selectedFreeKickPlayer = null;
        let selectedInjuryPlayer = null;
        let currentLiveId = null;
        // Variables pour le modal gardien
        let selectedGoalkeeperTeam = null;
        let selectedSaveType = null;
        
        // Variables pour le timer
        let matchTimer = {
            startTime: null,
            pausedTime: 0,
            isRunning: false,
            currentHalf: 1,
            interval: null
        };
        
        // Tableau des √©v√©nements
        let matchEvents = [];

        // Synchroniser matchEvents avec footballApp au chargement
        function syncMatchEventsWithApp() {
            if (typeof footballApp !== 'undefined') {
                const appEvents = footballApp.getState().events;
                if (appEvents && appEvents.length > 0) {
                    matchEvents = appEvents;
                    console.log(`üîÑ Synchronisation: ${matchEvents.length} √©v√©nements charg√©s depuis footballApp`);
                }
            }
        }

        // Appeler la synchronisation toutes les secondes
        setInterval(syncMatchEventsWithApp, 1000);        
        
        // Stats du match
        let matchStats = {
            myTeam: { goals: 0, shots: 0, cards: 0, fouls: 0, saves: 0, freeKicks: 0 },
            opponent: { goals: 0, shots: 0, cards: 0, fouls: 0, saves: 0, freeKicks: 0 }
        };

        // AJOUT FONCTION WAIT - POUR √âVITER LES ERREURS DE TIMING
        function waitForFootballApp(callback) {
            if (typeof footballApp !== 'undefined') {
                callback();
            } else {
                setTimeout(() => waitForFootballApp(callback), 100);
            }
        }

        // Initialisation de la page
        document.addEventListener('DOMContentLoaded', function() {
            initializeMatchPage();
        });

        /**
         * Initialisation de la page de match
         */
        function initializeMatchPage() {
            loadMatchConfig();
            loadSavedMatchData(); // Charger les donn√©es sauvegard√©es
            
            // Debug: V√©rifier les donn√©es des joueurs
            const players = getMyTeamPlayers();
            const fieldPlayers = players.filter(p => p.status === 'field');
            console.log(`Joueurs charg√©s: ${players.length} total, ${fieldPlayers.length} sur le terrain`);
            if (fieldPlayers.length === 0) {
                console.warn('Aucun joueur sur le terrain - configurez votre composition d\'√©quipe');
            }
            
            updateMatchDisplay();
            startPeriodicSave();
            console.log('Page de match initialis√©e');
        }

        // ===== NOUVELLES FONCTIONS DE RESET - AJOUT MINIMAL =====

        /**
         * Reset visuel complet de la page match
         */
        function resetMatchPageDisplay() {
            // Remettre les scores √† 0
            document.getElementById('teamScore').textContent = '0';
            document.getElementById('opponentScore').textContent = '0';
            
            // Remettre le temps √† 00:00
            document.getElementById('matchTime').textContent = '00:00';
            
            // Remettre √† la 1√®re mi-temps
            document.getElementById('matchHalf').textContent = '1√®re Mi-temps';
            
            // Vider la timeline
            document.getElementById('eventsTimeline').innerHTML = '<div style="text-align: center; padding: 20px; color: #bbb;">Aucun √©v√©nement enregistr√©</div>';
            
            // Reset des stats visuelles
            const statElements = ['compactTeamGoals', 'compactOpponentGoals', 'compactTeamShots', 'compactOpponentShots', 
                                'compactTeamCards', 'compactOpponentCards', 'compactTeamFouls', 'compactOpponentFouls',
                                'compactTeamSaves', 'compactOpponentSaves', 'compactTeamFreeKicks', 'compactOpponentFreeKicks'];
            statElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = '0';
            });

            // Reset des variables locales
            matchEvents = [];
            matchStats = {
                myTeam: { goals: 0, shots: 0, cards: 0, fouls: 0, saves: 0, freeKicks: 0 },
                opponent: { goals: 0, shots: 0, cards: 0, fouls: 0, saves: 0, freeKicks: 0 }
            };
        }

        /**
         * Fonction √† appeler pour un nouveau match depuis la page match
         */
        function newMatchFromMatchPage() {
            if (confirm('üÜï Cr√©er un nouveau match ?\n\n‚ö†Ô∏è Le match actuel sera perdu !')) {
                waitForFootballApp(function() {
                    // Utiliser la fonction de footballApp si disponible
                    if (typeof footballApp !== 'undefined' && footballApp.startNewMatch) {
                        footballApp.startNewMatch();
                    }
                    
                    // Reset visuel imm√©diat
                    resetMatchPageDisplay();
                    
                    // Reset du timer local
                    if (matchTimer.interval) {
                        clearInterval(matchTimer.interval);
                    }
                    matchTimer = {
                        startTime: null,
                        pausedTime: 0,
                        isRunning: false,
                        currentHalf: 1,
                        interval: null
                    };
                    
                    // Reset bouton timer
                    const playBtn = document.getElementById('playBtn');
                    if (playBtn) {
                        playBtn.innerHTML = '‚ñ∂Ô∏è D√©marrer';
                        playBtn.className = 'btn btn-success';
                    }
                    
                    // Notification
                    console.log('üÜï Nouveau match cr√©√© !');
                    alert('üÜï Nouveau match cr√©√© !');
                });
            }
        }

        /**
         * Fonction √† appeler pour reset complet depuis la page match
         */
        function resetAllFromMatchPage() {
            if (confirm('üîÑ Reset complet ?\n\n‚ö†Ô∏è TOUTES les donn√©es seront perdues !')) {
                waitForFootballApp(function() {
                    // Utiliser la fonction de footballApp si disponible
                    if (typeof footballApp !== 'undefined' && footballApp.resetCompleteApp) {
                        footballApp.resetCompleteApp();
                    } else {
                        // Fallback - effacer manuellement
                        localStorage.clear();
                    }
                    
                    // Reset visuel imm√©diat
                    resetMatchPageDisplay();
                    
                    // Notification
                    console.log('üîÑ Reset complet effectu√© !');
                    alert('üîÑ Reset complet effectu√© !');
                    
                    // Recharger la page
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                });
            }
        }

        // ===== TOUTES LES AUTRES FONCTIONS ORIGINALES INCHANG√âES =====

        /**
         * Chargement de la configuration du match
         */
        function loadMatchConfig() {
            const config = getMatchConfig();
            document.getElementById('teamName').textContent = config.teamName || 'Mon √âquipe';
            document.getElementById('opponentName').textContent = config.opponentName || '√âquipe Adverse';
        }
        
        /**
         * Chargement des donn√©es de match sauvegard√©es
         */
        function loadSavedMatchData() {
            try {
                const savedData = localStorage.getItem('currentMatch');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    
                    // Support ancien et nouveau format
                    const timerData = data.timer || data;
                    const eventsData = data.events || [];
                    const statsData = data.stats || { myTeam: { goals: 0, shots: 0, cards: 0, fouls: 0, saves: 0, freeKicks: 0 }, opponent: { goals: 0, shots: 0, cards: 0, fouls: 0, saves: 0, freeKicks: 0 } };
                    
                    // Restaurer le timer
                    if (timerData) {
                        matchTimer = { ...matchTimer, ...timerData };
                        
                        // Si le timer √©tait en cours, recalculer le temps √©coul√©
                        if (matchTimer.isRunning && matchTimer.startTime) {
                            const now = Date.now();
                            
                            // Convertir la startTime ISO en timestamp
                            let savedStartTime;
                            if (typeof matchTimer.startTime === 'string') {
                                savedStartTime = new Date(matchTimer.startTime).getTime();
                            } else {
                                savedStartTime = matchTimer.startTime;
                            }
                            
                            // Calculer le temps √©coul√© depuis la sauvegarde
                            const savedAt = timerData.savedAt ? new Date(timerData.savedAt).getTime() : now;
                            const timeSinceSave = now - savedAt;
                            
                            // Ajouter le temps √©coul√© depuis la sauvegarde
                            const elapsedSinceStart = (savedAt - savedStartTime) / 1000;
                            matchTimer.pausedTime = elapsedSinceStart + (timeSinceSave / 1000);
                            
                            // Red√©marrer le timer
                            matchTimer.startTime = now - (matchTimer.pausedTime * 1000);
                            matchTimer.interval = setInterval(updateTimer, 1000);
                            
                            // Mettre √† jour l'interface
                            document.getElementById('playBtn').innerHTML = '‚è∏Ô∏è Pause';
                            document.getElementById('playBtn').classList.remove('btn-success');
                            document.getElementById('playBtn').classList.add('btn-warning');
                            
                            console.log('‚è±Ô∏è Timer restaur√© et relanc√© automatiquement');
                        } else {
                            // Timer en pause, juste restaurer l'√©tat
                            document.getElementById('playBtn').innerHTML = '‚ñ∂Ô∏è Reprendre';
                            document.getElementById('playBtn').classList.remove('btn-warning');
                            document.getElementById('playBtn').classList.add('btn-success');
                        }
                        
                        updateTimerDisplay();
                        
                        // Mettre √† jour l'affichage de la mi-temps
                        document.getElementById('matchHalf').textContent = 
                            matchTimer.currentHalf === 1 ? '1√®re Mi-temps' : '2√®me Mi-temps';
                    }
                    
                    // Restaurer les √©v√©nements
                    if (eventsData && eventsData.length > 0) {
                        matchEvents = eventsData;
                        updateTimeline();
                        console.log(`üìù ${matchEvents.length} √©v√©nements restaur√©s`);
                    }
                    
                    // Restaurer les stats
                    if (statsData) {
                        matchStats = statsData;
                        console.log('üìä Statistiques restaur√©es');
                    }
                    
                    // Restaurer les informations du match si disponibles
                    if (data.matchInfo) {
                        document.getElementById('teamName').textContent = data.matchInfo.teamName;
                        document.getElementById('opponentName').textContent = data.matchInfo.opponentName;
                        console.log('‚ÑπÔ∏è Informations du match restaur√©es');
                    }
                    
                    console.log('‚úÖ Donn√©es de match restaur√©es compl√®tement');
                }
            } catch (error) {
                console.error('‚ùå Erreur lors du chargement des donn√©es:', error);
            }
        }

        // ===== GESTION DU TIMER =====
        
        function toggleTimer() {
            if (matchTimer.isRunning) {
                stopTimer();
            } else {
                startTimer();
            }
        }
        
        function startTimer() {
            if (matchTimer.isRunning) return;
            
            matchTimer.isRunning = true;
            matchTimer.startTime = Date.now() - (matchTimer.pausedTime * 1000);
            
            matchTimer.interval = setInterval(updateTimer, 1000);
            
            document.getElementById('playBtn').innerHTML = '‚è∏Ô∏è Pause';
            document.getElementById('playBtn').classList.remove('btn-success');
            document.getElementById('playBtn').classList.add('btn-warning');
            
            console.log('‚è±Ô∏è Timer d√©marr√©:', new Date(matchTimer.startTime));
            
            // Sauvegarder imm√©diatement pour le live
            autoSave().then(() => {
                console.log('üî¥ D√©marrage timer sauvegard√© pour le live');
            });
        }
        
        function stopTimer() {
            if (!matchTimer.isRunning) return;
            
            matchTimer.isRunning = false;
            matchTimer.pausedTime = (Date.now() - matchTimer.startTime) / 1000;
            
            clearInterval(matchTimer.interval);
            
            document.getElementById('playBtn').innerHTML = '‚ñ∂Ô∏è Reprendre';
            document.getElementById('playBtn').classList.remove('btn-warning');
            document.getElementById('playBtn').classList.add('btn-success');
            
            console.log('‚è∏Ô∏è Timer arr√™t√©');
            
            // Sauvegarder imm√©diatement pour le live
            autoSave().then(() => {
                console.log('üî¥ Arr√™t timer sauvegard√© pour le live');
            });
        }
        
        function resetTimer() {
            stopTimer();
            matchTimer.pausedTime = 0;
            matchTimer.startTime = null;
            updateTimerDisplay();
            
            document.getElementById('playBtn').innerHTML = '‚ñ∂Ô∏è D√©marrer';
            document.getElementById('playBtn').classList.remove('btn-warning');
            document.getElementById('playBtn').classList.add('btn-success');
            
            console.log('üîÑ Timer remis √† z√©ro');
            
            // Sauvegarder imm√©diatement pour le live
            autoSave().then(() => {
                console.log('üî¥ Reset timer sauvegard√© pour le live');
            });
        }
        
        function updateTimer() {
            if (!matchTimer.isRunning || !matchTimer.startTime) return;
            
            const elapsedSeconds = (Date.now() - matchTimer.startTime) / 1000;
            let totalSeconds = Math.floor(elapsedSeconds);
            
            // Pour la deuxi√®me mi-temps, commencer √† 45 minutes
            if (matchTimer.currentHalf === 2) {
                totalSeconds += 45 * 60;
            }
            
            updateTimerDisplay(totalSeconds);
            
            // Sauvegarder toutes les minutes
            if (totalSeconds % 60 === 0) {
                autoSave();
            }
        }
        
        function updateTimerDisplay(totalSeconds = null) {
            if (totalSeconds === null) {
                totalSeconds = matchTimer.pausedTime;
                if (matchTimer.currentHalf === 2) {
                    totalSeconds += 45 * 60;
                }
            }
            
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.floor(totalSeconds % 60);
            
            let displayTime;
            if (minutes >= 45 && matchTimer.currentHalf === 1) {
                const overtimeMinutes = minutes - 45;
                displayTime = `45+${overtimeMinutes}:${seconds.toString().padStart(2, '0')}`;
            } else if (minutes >= 90 && matchTimer.currentHalf === 2) {
                const overtimeMinutes = minutes - 90;
                displayTime = `90+${overtimeMinutes}:${seconds.toString().padStart(2, '0')}`;
            } else {
                displayTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            document.getElementById('matchTime').textContent = displayTime;
        }
        
        function showHalfTimeConfirm() {
            if (matchTimer.currentHalf === 2) {
                if (confirm('Voulez-vous terminer le match ?')) {
                    endMatch();
                }
            } else {
                if (confirm('Voulez-vous passer √† la seconde mi-temps ?')) {
                    switchToSecondHalf();
                }
            }
        }
        
        function switchToSecondHalf() {
            stopTimer();
            matchTimer.currentHalf = 2;
            matchTimer.pausedTime = 0; // Reset √† 0 pour commencer la 2e mi-temps √† 45:00
            matchTimer.startTime = null;
            
            document.getElementById('matchHalf').textContent = '2√®me Mi-temps';
            updateTimerDisplay();
            
            addEvent('system', {
                description: 'D√©but de la 2√®me mi-temps',
                team: null
            });
            
            // Sauvegarder imm√©diatement pour le live
            autoSave().then(() => {
                console.log('üîÑ D√©but 2√®me mi-temps sauvegard√© pour le live');
            });
        }
        
        function endMatch() {
            stopTimer();
            addEvent('system', {
                description: 'Fin du match',
                team: null
            });
            
            // Sauvegarder imm√©diatement pour le live
            autoSave().then(() => {
                console.log('üèÅ Fin de match sauvegard√©e pour le live');
            });
            
            alert('üèÅ Match termin√© ! Consultez les statistiques dans l\'onglet Stats.\n\n' +
                  'üì± Le lien live reste actif pour consulter les r√©sultats finaux.');
        }

        // ===== GESTION DES MODALS =====
        
        function showTeamChoiceModal(actionType) {
            currentActionType = actionType;
            
            // Aller directement au modal d'action avec tous les joueurs
            showActionModal();
        }
        
        function showActionModal() {
            const titles = {
                'goal': 'Qui a marqu√© le but ?',
                'shot': 'Qui a tir√© ?',
                'card': 'Qui re√ßoit le carton ?',
                'foul': 'Qui a commis la faute ?',
                'freekick': 'Qui tire le coup franc ?'
            };
            
            document.getElementById('actionModalTitle').textContent = titles[currentActionType] || 'Action';
            
            // Afficher/cacher les √©l√©ments sp√©cifiques
            const cardButtons = document.getElementById('cardButtons');
            const assistSelection = document.getElementById('assistSelection');
            
            cardButtons.style.display = currentActionType === 'card' ? 'block' : 'none';
            assistSelection.style.display = currentActionType === 'goal' ? 'block' : 'none';
            
            // Charger tous les joueurs + bouton adversaire
            loadAllPlayersForAction();
            
            // Reset des s√©lections
            selectedPlayerId = null;
            selectedAssistPlayerId = null;
            selectedCardType = null;
            selectedTeam = null;
            
            document.getElementById('actionModal').style.display = 'block';
            updateSaveButton();
        }
        
        function loadAllPlayersForAction() {
            const container = document.getElementById('actionPlayerButtons');
            const assistContainer = document.getElementById('assistPlayerButtons');
            container.innerHTML = '';
            if (assistContainer) assistContainer.innerHTML = '';
            
            // Charger SEULEMENT les 11 joueurs sur le terrain
            const allPlayers = getMyTeamPlayers();
            const fieldPlayers = allPlayers.filter(p => p.status === 'field'); // Seulement les titulaires
            
            console.log(`Affichage de ${fieldPlayers.length} joueurs sur le terrain`);
            
            fieldPlayers.forEach(player => {
                // V√©rifier si le joueur a un carton rouge (ne pas l'afficher)
                const hasRedCard = matchEvents.some(event => 
                    event.type === 'card' && 
                    event.cardType === 'red' && 
                    event.playerId === player.id
                );
                
                if (!hasRedCard) {
                    const button = document.createElement('button');
                    button.className = 'player-btn';
                    
                    // Indicateur de statut
                    let statusIcon = 'üü¢'; // Sur le terrain
                    if (player.position && player.position.toLowerCase().includes('garden')) {
                        button.style.background = 'rgba(230, 126, 34, 0.3)'; // Orange pour gardiens
                    }
                    
                    button.innerHTML = `
                        <div>${statusIcon} ${player.name}</div>
                        <div style="font-size: 0.8rem; opacity: 0.8;">${player.position || 'Joueur'}</div>
                    `;
                    button.onclick = () => selectPlayer(player.id, button, 'my-team');
                    container.appendChild(button);
                    
                    // Ajouter aussi dans la s√©lection d'assistance si c'est un but
                    if (currentActionType === 'goal' && assistContainer) {
                        const assistButton = document.createElement('button');
                        assistButton.className = 'player-btn assist-btn';
                        assistButton.innerHTML = `
                            <div>${statusIcon} ${player.name}</div>
                            <div style="font-size: 0.8rem; opacity: 0.8;">${player.position || 'Joueur'}</div>
                        `;
                        assistButton.onclick = () => selectAssistPlayer(player.id, assistButton);
                        assistContainer.appendChild(assistButton);
                    }
                }
            });
            
            // Ajouter le bouton adversaire (un seul bouton)
            const opponentButton = document.createElement('button');
            opponentButton.className = 'player-btn opponent';
            opponentButton.style.background = 'rgba(231, 76, 60, 0.3)';
            opponentButton.innerHTML = `
                <div>üî¥ √âquipe Adverse</div>
                <div style="font-size: 0.8rem; opacity: 0.8;">Joueur adverse</div>
            `;
            opponentButton.onclick = () => selectPlayer('opponent_player', opponentButton, 'opponent');
            container.appendChild(opponentButton);
            
            // Message informatif si moins de 11 joueurs
            if (fieldPlayers.length < 11) {
                console.warn(`Attention: seulement ${fieldPlayers.length} joueurs sur le terrain (11 attendus)`);
            }
        }
        
        function selectPlayer(playerId, buttonElement, team) {
            selectedPlayerId = playerId;
            selectedTeam = team;
            
            // Mise √† jour visuelle
            const buttons = document.querySelectorAll('#actionPlayerButtons .player-btn');
            buttons.forEach(btn => btn.classList.remove('selected'));
            buttonElement.classList.add('selected');
            
            // G√©rer l'affichage de la s√©lection d'assistance
            const assistSelection = document.getElementById('assistSelection');
            if (currentActionType === 'goal' && team === 'my-team') {
                assistSelection.style.display = 'block';
            } else {
                assistSelection.style.display = 'none';
            }
            
            updateSaveButton();
        }
        
        function selectAssistPlayer(playerId, buttonElement) {
            selectedAssistPlayerId = playerId;
            
            // Mise √† jour visuelle
            const buttons = document.querySelectorAll('#assistPlayerButtons .assist-btn');
            buttons.forEach(btn => btn.classList.remove('selected'));
            buttonElement.classList.add('selected');
        }
        
        function selectCardType(cardType) {
            selectedCardType = cardType;
            
            // Mise √† jour visuelle
            const buttons = document.querySelectorAll('.card-btn');
            buttons.forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');
            
            updateSaveButton();
        }
        
        function updateSaveButton() {
            const saveBtn = document.getElementById('saveActionBtn');
            if (!saveBtn) return;
            
            let canSave = selectedPlayerId !== null;
            
            // Pour les cartons, il faut aussi s√©lectionner le type
            if (currentActionType === 'card') {
                canSave = canSave && selectedCardType !== null;
            }
            
            saveBtn.disabled = !canSave;
        }
        
        function closeActionModal() {
            document.getElementById('actionModal').style.display = 'none';
            
            // Reset des s√©lections
            selectedPlayerId = null;
            selectedAssistPlayerId = null;
            selectedCardType = null;
            selectedTeam = null;
            currentActionType = null;
        }
        
        function saveAction() {
            if (!selectedPlayerId) {
                alert('S√©lectionnez un joueur');
                return;
            }
            
            if (currentActionType === 'card' && !selectedCardType) {
                alert('S√©lectionnez un type de carton');
                return;
            }
            
            // Cr√©er l'√©v√©nement
            const eventData = {
                type: currentActionType,
                team: selectedTeam,
                playerId: selectedPlayerId,
                time: getCurrentMatchTime()
            };
            
            if (currentActionType === 'card') {
                eventData.cardType = selectedCardType;
            }
            
            if (currentActionType === 'goal' && selectedAssistPlayerId) {
                eventData.assistPlayerId = selectedAssistPlayerId;
            }
            
            // Ajouter l'√©v√©nement
            addEvent(currentActionType, eventData);
            
            // Mettre √† jour les stats
            updateMatchStats(eventData);
            
            closeActionModal();
            updateMatchDisplay();
            
            // Sauvegarder imm√©diatement pour le live
            autoSave().then(() => {
                console.log('üî¥ Action sauvegard√©e imm√©diatement pour le live');
            });
            
            // Notification de succ√®s
            const actionNames = {
                'goal': 'But',
                'shot': 'Tir',
                'card': 'Carton',
                'foul': 'Faute',
                'freekick': 'Coup franc'
            };
            console.log(`‚úÖ ${actionNames[currentActionType]} enregistr√© !`);
        }

        // ===== GESTION DU MODAL GARDIEN =====
        
        function showGoalkeeperModal() {
            // Reset des s√©lections
            selectedGoalkeeperTeam = null;
            selectedSaveType = null;
            
            // Cacher la section types d'arr√™t
            document.getElementById('saveTypeSection').style.display = 'none';
            
            // Reset des boutons
            resetGoalkeeperButtons();
            
            // Charger le nom du gardien de mon √©quipe
            loadMyGoalkeeperName();
            
            document.getElementById('goalkeeperModal').style.display = 'block';
        }
        
        function loadMyGoalkeeperName() {
            const players = getMyTeamPlayers();
            
            // Chercher le gardien sur le terrain (titulaire)
            const goalkeeper = players.find(p => 
                p.status === 'field' && 
                p.position && 
                (p.position.toLowerCase().includes('garden') || 
                 p.position.toLowerCase().includes('goal') ||
                 p.position.toLowerCase().includes('gb'))
            );
            
            const nameElement = document.getElementById('myGoalkeeperName');
            if (goalkeeper && goalkeeper.name) {
                nameElement.textContent = goalkeeper.name;
                console.log(`üß§ Gardien titulaire trouv√©: ${goalkeeper.name}`);
            } else {
                nameElement.textContent = 'Mon Gardien';
                console.warn('‚ö†Ô∏è Aucun gardien trouv√© dans la composition');
                
                // Debug: afficher tous les joueurs sur le terrain
                const fieldPlayers = players.filter(p => p.status === 'field');
                console.log('Joueurs sur le terrain:', fieldPlayers.map(p => `${p.name} (${p.position})`));
            }
        }
        
        function selectGoalkeeperTeam(team) {
            selectedGoalkeeperTeam = team;
            
            // Mise √† jour visuelle
            resetGoalkeeperButtons();
            const selectedBtn = document.querySelector(`.goalkeeper-choice-btn.${team === 'my-team' ? 'my-gk' : 'opponent-gk'}`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }
            
            // Afficher la section types d'arr√™t
            document.getElementById('saveTypeSection').style.display = 'block';
            
            // Reset la s√©lection du type d'arr√™t
            selectedSaveType = null;
            resetSaveTypeButtons();
            updateGoalkeeperSaveButton();
        }
        
        function selectSaveType(saveType) {
            selectedSaveType = saveType;
            
            // Mise √† jour visuelle
            resetSaveTypeButtons();
            const selectedBtn = document.querySelector(`.save-type-btn[data-type="${saveType}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected');
            }
            
            updateGoalkeeperSaveButton();
        }
        
        function resetGoalkeeperButtons() {
            const buttons = document.querySelectorAll('.goalkeeper-choice-btn');
            buttons.forEach(btn => btn.classList.remove('selected'));
        }
        
        function resetSaveTypeButtons() {
            const buttons = document.querySelectorAll('.save-type-btn');
            buttons.forEach(btn => btn.classList.remove('selected'));
        }
        
        function updateGoalkeeperSaveButton() {
            const saveBtn = document.getElementById('saveGoalkeeperBtn');
            saveBtn.disabled = !selectedGoalkeeperTeam || !selectedSaveType;
        }
        
        function closeGoalkeeperModal() {
            document.getElementById('goalkeeperModal').style.display = 'none';
            selectedGoalkeeperTeam = null;
            selectedSaveType = null;
            resetGoalkeeperButtons();
            resetSaveTypeButtons();
        }
        
        function saveGoalkeeperAction() {
            if (!selectedGoalkeeperTeam || !selectedSaveType) {
                alert('S√©lectionnez un gardien et un type d\'arr√™t');
                return;
            }
            
            // Cr√©er l'√©v√©nement
            const eventData = {
                type: 'save',
                team: selectedGoalkeeperTeam,
                playerId: selectedGoalkeeperTeam === 'my-team' ? 'my_goalkeeper' : 'opponent_goalkeeper',
                saveType: selectedSaveType,
                time: getCurrentMatchTime()
            };
            
            addEvent('save', eventData);
            updateMatchStats(eventData);
            
            closeGoalkeeperModal();
            updateMatchDisplay();
            
            // Sauvegarder imm√©diatement pour le live
            autoSave().then(() => {
                console.log('üß§ Arr√™t gardien sauvegard√© imm√©diatement pour le live');
            });
            
            console.log('‚úÖ Arr√™t gardien enregistr√© !');
        }

        // ===== GESTION DES √âV√âNEMENTS =====
        
        function getCurrentMatchTime() {
            let totalSeconds = matchTimer.pausedTime;
            if (matchTimer.isRunning && matchTimer.startTime) {
                totalSeconds = (Date.now() - matchTimer.startTime) / 1000;
            }
            
            if (matchTimer.currentHalf === 2) {
                totalSeconds += 45 * 60;
            }
            
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.floor(totalSeconds % 60);
            
            if (minutes >= 45 && matchTimer.currentHalf === 1) {
                const overtimeMinutes = minutes - 45;
                return `45+${overtimeMinutes}:${seconds.toString().padStart(2, '0')}`;
            } else if (minutes >= 90 && matchTimer.currentHalf === 2) {
                const overtimeMinutes = minutes - 90;
                return `90+${overtimeMinutes}:${seconds.toString().padStart(2, '0')}`;
            } else {
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        function addEvent(type, data) {
            const event = {
                id: Date.now(),
                type: type,
                ...data,
                timestamp: new Date()
            };
            
            matchEvents.unshift(event); // Ajouter au d√©but pour avoir les plus r√©cents en haut

            // Synchroniser aussi avec footballApp
            if (typeof footballApp !== 'undefined') {
                // Mettre √† jour footballApp.getState().events
                const appState = footballApp.getState();
                if (!appState.events.find(e => e.id === event.id)) {
                    appState.events.unshift(event);
                    footballApp.saveState();
                    console.log('‚úÖ √âv√©nement ajout√© et synchronis√© avec footballApp');
                }
            }

            updateTimeline();
        }
        
        function updateTimeline() {
            // Synchroniser d'abord
            syncMatchEventsWithApp();
            
            const container = document.getElementById('eventsTimeline');
            
            console.log(`üìä updateTimeline: ${matchEvents.length} √©v√©nements √† afficher`);
                        
            if (matchEvents.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #bbb;">Aucun √©v√©nement enregistr√©</div>';
                return;
            }
            
            container.innerHTML = '';
            
            matchEvents.forEach(event => {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'timeline-event';
                
                const leftDiv = document.createElement('div');
                const timeDiv = document.createElement('div');
                const rightDiv = document.createElement('div');
                
                leftDiv.className = 'event-left';
                timeDiv.className = 'event-time';
                rightDiv.className = 'event-right';
                
                timeDiv.textContent = event.time;
                
                if (event.team === 'my-team') {
                    leftDiv.innerHTML = getEventDescription(event);
                    rightDiv.innerHTML = '';
                } else if (event.team === 'opponent') {
                    leftDiv.innerHTML = '';
                    rightDiv.innerHTML = getEventDescription(event);
                } else {
                    // √âv√©nements syst√®me (mi-temps, etc.)
                    leftDiv.innerHTML = '';
                    rightDiv.innerHTML = '';
                    timeDiv.innerHTML = `<div style="text-align: center; font-style: italic;">${event.description || getEventDescription(event)}</div>`;
                }
                
                eventDiv.appendChild(leftDiv);
                eventDiv.appendChild(timeDiv);
                eventDiv.appendChild(rightDiv);
                
                container.appendChild(eventDiv);
            });
        }
        
        function getEventDescription(event) {
            const playerName = getPlayerName(event.playerId);
            
            switch (event.type) {
                case 'goal':
                    let goalText = `‚öΩ ${playerName}`;
                    if (event.assistPlayerId) {
                        const assistName = getPlayerName(event.assistPlayerId);
                        goalText += `<br><small>üéØ Passe: ${assistName}</small>`;
                    }
                    return goalText;
                case 'shot':
                    return `üéØ Tir - ${playerName}`;
                case 'card':
                    const cardEmoji = event.cardType === 'yellow' ? 'üü®' : event.cardType === 'red' ? 'üü•' : '‚ö™';
                    return `${cardEmoji} Carton - ${playerName}`;
                case 'foul':
                    return `‚ö†Ô∏è Faute - ${playerName}`;
                case 'save':
                    const saveTypeText = {
                        'line': 'sur sa ligne',
                        'out': 'en sortie',
                        'penalty': 'penalty',
                        'corner': 'corner'
                    };
                    return `üß§ Arr√™t ${saveTypeText[event.saveType] || ''} - ${playerName}`;
                case 'freekick':
                    return `‚öΩ Coup Franc - ${playerName}`;
                default:
                    return event.description || `${event.type} - ${playerName}`;
            }
        }
        
        function getPlayerName(playerId) {
            if (typeof playerId === 'string') {
                if (playerId.startsWith('opponent_') || playerId === 'opponent_player') {
                    return 'Joueur Adverse';
                }
                if (playerId === 'my_goalkeeper') {
                    const players = getMyTeamPlayers();
                    const goalkeeper = players.find(p => 
                        p.status === 'field' && 
                        p.position && 
                        p.position.toLowerCase().includes('garden')
                    );
                    return goalkeeper ? goalkeeper.name : 'Mon Gardien';
                }
                if (playerId === 'opponent_goalkeeper') {
                    return 'Gardien Adverse';
                }
            }
            
            // R√©cup√©rer le nom du joueur depuis les donn√©es de l'√©quipe
            const players = getMyTeamPlayers();
            const player = players.find(p => p.id === playerId);
            return player ? player.name : 'Joueur';
        }
        
        function updateMatchStats(eventData) {
            const team = eventData.team === 'my-team' ? 'myTeam' : 'opponent';
            
            switch (eventData.type) {
                case 'goal':
                    matchStats[team].goals++;
                    break;
                case 'shot':
                    matchStats[team].shots++;
                    break;
                case 'card':
                    matchStats[team].cards++;
                    break;
                case 'foul':
                    matchStats[team].fouls++;
                    break;
                case 'save':
                    matchStats[team].saves++;
                    break;
                case 'freekick':
                    matchStats[team].freeKicks++;
                    break;
            }
        }
        
        function updateMatchDisplay() {
            // Mettre √† jour les scores
            document.getElementById('teamScore').textContent = matchStats.myTeam.goals;
            document.getElementById('opponentScore').textContent = matchStats.opponent.goals;
            
            // Mettre √† jour les stats rapides
            updateQuickStats();
        }
        
        function updateQuickStats() {
            // Mettre √† jour les statistiques compactes
            document.getElementById('compactTeamGoals').textContent = matchStats.myTeam.goals;
            document.getElementById('compactOpponentGoals').textContent = matchStats.opponent.goals;
            document.getElementById('compactTeamShots').textContent = matchStats.myTeam.shots;
            document.getElementById('compactOpponentShots').textContent = matchStats.opponent.shots;
            document.getElementById('compactTeamCards').textContent = matchStats.myTeam.cards;
            document.getElementById('compactOpponentCards').textContent = matchStats.opponent.cards;
            document.getElementById('compactTeamFouls').textContent = matchStats.myTeam.fouls;
            document.getElementById('compactOpponentFouls').textContent = matchStats.opponent.fouls;
            document.getElementById('compactTeamSaves').textContent = matchStats.myTeam.saves;
            document.getElementById('compactOpponentSaves').textContent = matchStats.opponent.saves;
            document.getElementById('compactTeamFreeKicks').textContent = matchStats.myTeam.freeKicks || 0;
            document.getElementById('compactOpponentFreeKicks').textContent = matchStats.opponent.freeKicks || 0;
        }

        // ===== FONCTIONS UTILITAIRES =====
        
        function getMyTeamPlayers() {
            // D'abord essayer de r√©cup√©rer depuis l'√©tat de l'application (app.js)
            if (typeof footballApp !== 'undefined' && footballApp.getState) {
                const appState = footballApp.getState();
                if (appState.players && appState.players.length > 0) {
                    console.log('Joueurs r√©cup√©r√©s depuis footballApp:', appState.players.length);
                    return appState.players;
                }
            }
            
            // Sinon r√©cup√©rer depuis le stockage local direct
            const players = JSON.parse(localStorage.getItem('footballStats_players') || '[]');
            console.log('Joueurs r√©cup√©r√©s depuis localStorage:', players.length);
            
            // Si pas de statut d√©fini, marquer tous comme sur le banc par d√©faut
            return players.map(player => ({
                ...player,
                status: player.status || 'bench',
                id: player.id || `player_${Date.now()}_${Math.random()}`
            }));
        }
        
        function getMyTeamGoalkeepers() {
            const players = getMyTeamPlayers();
            return players.filter(p => p.position.toLowerCase().includes('garden') || p.position.toLowerCase().includes('goal'));
        }
        
        function getMatchConfig() {
            return JSON.parse(localStorage.getItem('footballStats_matchConfig') || '{"teamName": "Mon √âquipe", "opponentName": "√âquipe Adverse"}');
        }
        
        function startPeriodicSave() {
            // Sauvegarder automatiquement toutes les 30 secondes
            setInterval(autoSave, 30000);
            
            // Sauvegarder aussi quand le timer est en marche (toutes les 10 secondes pour le live)
            setInterval(() => {
                if (matchTimer.isRunning) {
                    autoSave();
                }
            }, 10000);
            
            console.log('üíæ Sauvegarde automatique configur√©e (30s + 10s si timer actif)');
        }
        
        async function autoSave() {
            // Pr√©parer TOUTES les donn√©es n√©cessaires pour le live
            const config = getMatchConfig();
            const players = getMyTeamPlayers();
            
            const completeMatchData = {
                // Informations du match
                matchInfo: {
                    teamName: config.teamName || 'Mon √âquipe',
                    opponentName: config.opponentName || '√âquipe Adverse',
                    venue: config.venue || 'Terrain',
                    date: new Date().toISOString().split('T')[0],
                    startTime: config.startTime || '15:00'
                },
                
                // Timer complet
                timer: {
                    ...matchTimer,
                    // Sauvegarder les timestamps comme cha√Ænes ISO pour √©viter les probl√®mes de s√©rialisation
                    startTime: matchTimer.startTime ? new Date(matchTimer.startTime).toISOString() : null,
                    savedAt: new Date().toISOString(),
                    currentTime: getCurrentMatchTime(),
                    isRunning: matchTimer.isRunning,
                    currentHalf: matchTimer.currentHalf,
                    pausedTime: matchTimer.pausedTime
                },
                
                // Tous les joueurs et leur composition
                players: players.map(player => ({
                    id: player.id,
                    name: player.name,
                    position: player.position,
                    status: player.status || 'bench',
                    number: player.number || null
                })),
                
                // √âv√©nements complets
                events: matchEvents.map(event => ({
                    ...event,
                    playerName: getPlayerName(event.playerId),
                    formattedDescription: getEventDescription(event)
                })),
                
                // Statistiques compl√®tes
                stats: {
                    ...matchStats,
                    // Score actuel (pour affichage rapide)
                    score: {
                        myTeam: matchStats.myTeam.goals,
                        opponent: matchStats.opponent.goals
                    }
                },
                
                // M√©tadonn√©es pour le live
                live: {
                    lastUpdate: new Date().toISOString(),
                    isActive: true,
                    spectatorCount: 0, // Peut √™tre mis √† jour c√¥t√© serveur
                    version: '1.0'
                }
            };
            
            // Sauvegarder localement (toujours fonctionnel)
            localStorage.setItem('currentMatch', JSON.stringify(completeMatchData));
            
            // Sauvegarder sur jsonbin.io (pour le live)
            try {
                const binId = await saveToJsonBin(completeMatchData);
                if (binId) {
                    console.log('üî¥ Match complet sauvegard√© automatiquement sur JsonBin pour le live');
                    
                    // Sauvegarder l'ID du bin pour le lien live
                    if (!localStorage.getItem('matchBinId')) {
                        localStorage.setItem('matchBinId', binId);
                    }
                } else {
                    console.log('üíæ Match sauvegard√© localement seulement');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Sauvegarde locale uniquement (JsonBin indisponible)');
            }
        }
        
        async function saveToJsonBin(data) {
            // Votre API key JsonBin.io configur√©e
            const API_KEY = '$2a$10$L3uaRDnltfCsdgv50dAJ0.aTJsslnmT2SPju9EPNd6HvXqW6u9KmS';
            const API_BASE_URL = 'https://api.jsonbin.io/v3/b';
            
            try {
                // D'abord v√©rifier si on a d√©j√† un bin ID
                let binId = localStorage.getItem('matchBinId');
                
                if (binId) {
                    // Mettre √† jour le bin existant
                    const response = await fetch(`${API_BASE_URL}/${binId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': API_KEY,
                            'X-Bin-Versioning': 'false'
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Erreur mise √† jour JsonBin: ${response.status}`);
                    }
                    
                    console.log('Match mis √† jour sur JsonBin');
                    return binId;
                } else {
                    // Cr√©er un nouveau bin
                    const response = await fetch(API_BASE_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': API_KEY,
                            'X-Bin-Private': 'false'
                        },
                        body: JSON.stringify(data)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Erreur cr√©ation JsonBin: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    binId = result.metadata.id;
                    
                    // Sauvegarder le bin ID
                    localStorage.setItem('matchBinId', binId);
                    console.log('Nouveau bin cr√©√© sur JsonBin:', binId);
                    
                    return binId;
                }
            } catch (error) {
                console.error('Erreur JsonBin:', error);
                // Ne pas lever l'erreur pour ne pas bloquer l'application
                // La sauvegarde locale fonctionne toujours
                return null;
            }
        }
        
        // Nettoyage avant fermeture de la page
        window.addEventListener('beforeunload', function() {
            if (matchTimer.interval) {
                clearInterval(matchTimer.interval);
                console.log('Timer arr√™t√© avant fermeture de page');
            }
            // Derni√®re sauvegarde
            autoSave();
        });
        
        // Nettoyage lors du changement de page
        window.addEventListener('pagehide', function() {
            if (matchTimer.interval) {
                clearInterval(matchTimer.interval);
                console.log('Timer arr√™t√© lors du changement de page');
            }
        });
        
        async function generateLiveLink() {
            try {
                // Sauvegarder le match actuel
                await autoSave();
                
                const binId = localStorage.getItem('matchBinId');
                
                if (binId) {
                    const liveLink = `${window.location.origin}${window.location.pathname}?live=${binId}`;
                    
                    // Copier le lien dans le presse-papiers
                    if (navigator.clipboard) {
                        await navigator.clipboard.writeText(liveLink);
                        alert(`Lien live copi√© dans le presse-papiers !\n\n${liveLink}`);
                    } else {
                        // Fallback pour les navigateurs plus anciens
                        prompt('Copiez ce lien live:', liveLink);
                    }
                } else {
                    alert('Configurez d\'abord votre API key JsonBin.io pour activer le live');
                }
            } catch (error) {
                console.error('Erreur g√©n√©ration lien live:', error);
                alert('Erreur lors de la g√©n√©ration du lien live');
            }
        }

        // === CONNEXION AVEC match_actions.js ===

        /**
         * Fonction appel√©e par match_actions.js pour mettre √† jour la timeline
         */
        function updateTimelineDisplay() {
            updateTimeline();
        }

        /**
         * Fonction appel√©e par match_actions.js pour obtenir le temps actuel
         */
        function getCurrentMatchTime() {
            let totalSeconds = matchTimer.pausedTime;
            if (matchTimer.isRunning && matchTimer.startTime) {
                totalSeconds = (Date.now() - matchTimer.startTime) / 1000;
            }
            
            if (matchTimer.currentHalf === 2) {
                totalSeconds += 45 * 60;
            }
            
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = Math.floor(totalSeconds % 60);
            
            if (minutes >= 45 && matchTimer.currentHalf === 1) {
                const overtimeMinutes = minutes - 45;
                return `45+${overtimeMinutes}:${seconds.toString().padStart(2, '0')}`;
            } else if (minutes >= 90 && matchTimer.currentHalf === 2) {
                const overtimeMinutes = minutes - 90;
                return `90+${overtimeMinutes}:${seconds.toString().padStart(2, '0')}`;
            } else {
                return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
        }

        /**
         * Exposer les fonctions pour match_actions.js
         */
        window.matchPageFunctions = {
            getCurrentTime: getCurrentMatchTime,
            updateTimeline: updateTimelineDisplay,
            getPlayers: getMyTeamPlayers,
            autoSave: autoSave
        };        
    </script>
</body>
</html>